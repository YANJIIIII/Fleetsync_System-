<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FINSI ‚Äî Project Manager</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="pm.css">
    <script>
        // Simulated user session
        window.pmUser = {
            name: 'Project Manager',
            role: 'Project Manager'
        };
        
        window.viewAccount = function(id) {
            const accountsLink = document.querySelector('[data-view="account-management"]');
            if (accountsLink) accountsLink.click();
        };
        
        window.viewTicketDetails = function(ticketId) {
            const modal = document.getElementById('ticketOverviewModal');
            if (!modal) { alert('Ticket overview modal not found.'); return; }
            
            // Find ticket in hardcoded data
            const hardcoded = getHardcodedAppointments();
            const allTickets = [...hardcoded.request, ...hardcoded.onhold, ...hardcoded.approved, ...hardcoded.rejected];
            const ticket = allTickets.find(t => t.id === ticketId);
            
            if (!ticket) { alert('Ticket not found.'); return; }

            // Populate ticket information
            document.getElementById('overviewTicket').textContent = ticket.ticketNumber || 'TKT-' + ticket.id;
            document.getElementById('overviewDate').textContent = ticket.date || 'N/A';
            document.getElementById('overviewSite').textContent = ticket.site || 'N/A';
            document.getElementById('overviewType').textContent = ticket.type || 'N/A';
            document.getElementById('overviewDescription').textContent = ticket.description || 'N/A';
            document.getElementById('overviewPriority').textContent = ticket.priority || 'Low';
            document.getElementById('overviewEmail').textContent = ticket.userEmail || 'N/A';
            
            // Store current ticket ID for remarks
            window.currentTicketId = ticket.id;

            // Populate engineer dropdown
            populateEngineerDropdown();

            // Show/hide sections based on ticket status
            updateModalSections(ticket);

            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        };

        function populateEngineerDropdown() {
            const select = document.getElementById('engineerSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select an engineer...</option>';
            const engineers = JSON.parse(localStorage.getItem('engineers') || '[]');
            engineers.forEach(eng => {
                const option = document.createElement('option');
                option.value = eng.id;
                option.textContent = `${eng.givenName || ''} ${eng.lastName || ''} - (${eng.location || 'N/A'})`;
                select.appendChild(option);
            });
            
            // Remove any existing event listeners by cloning the element
            const newSelect = select.cloneNode(true);
            select.parentNode.replaceChild(newSelect, select);
            
            // Add event listener to show/hide PM remarks field
            newSelect.addEventListener('change', function() {
                const pmRemarksField = document.getElementById('pmRemarksField');
                if (pmRemarksField) {
                    if (this.value) {
                        pmRemarksField.style.display = 'block';
                    } else {
                        pmRemarksField.style.display = 'none';
                    }
                }
            });
        }

        function updateModalSections(ticket) {
            const status = (ticket.status || '').toLowerCase();
            const hasEngineer = ticket.engineer && ticket.engineer !== '‚Äî' && ticket.engineer !== '';
            const assetStatus = (ticket.assetStatus || '').toLowerCase();
            const taskStatus = (ticket.taskStatus || '').toLowerCase();
            
            // Reset all buttons and sections
            document.getElementById('processBtn').style.display = 'none';
            document.getElementById('markDoneBtn2').style.display = 'none';
            document.getElementById('onHoldBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('notifyFOApproveBtn').style.display = 'none';
            document.getElementById('notifyFORejectBtn').style.display = 'none';
            document.getElementById('markDoneBtn').style.display = 'none';
            document.getElementById('currentAssignment').style.display = 'none';
            document.getElementById('engineerSelect').style.display = 'none';
            document.getElementById('pmRemarksField').style.display = 'none';
            document.getElementById('currentPMRemarks').style.display = 'none';
            document.getElementById('remarksSection').style.display = 'none';
            document.getElementById('currentStatusSection').style.display = 'none';
            document.getElementById('rejectionReasonSection').style.display = 'none';
            document.getElementById('doneSection').style.display = 'none';
            document.getElementById('onHoldRemarksSection').style.display = 'none';
            document.getElementById('foRemarksForm').style.display = 'none';

            if (status === 'pending') {
                // Request appointments - can process (which includes engineer assignment)
                document.getElementById('processBtn').style.display = 'inline-flex';
                document.getElementById('engineerSelect').style.display = 'block';
                // Reset PM remarks field for new assignment
                document.getElementById('pmRemarksText').value = '';
            } else if (status === 'on hold') {
                // In progress appointments - show remarks section and status
                document.getElementById('remarksSection').style.display = 'block';
                document.getElementById('currentStatusSection').style.display = 'block';
                
                // Show Remarks to Facility Owner form (always show to allow PM to add remarks)
                document.getElementById('foRemarksForm').style.display = 'block';
                
                // Update status indicator based on taskStatus
                const statusIndicator = document.getElementById('statusIndicator');
                if (taskStatus === 'pending') {
                    statusIndicator.innerHTML = '‚è≥ Pending';
                    statusIndicator.style.background = '#fef3c7';
                    statusIndicator.style.color = '#92400e';
                } else if (taskStatus === 'in_progress') {
                    statusIndicator.innerHTML = 'üîÑ Ongoing';
                    statusIndicator.style.background = '#dbeafe';
                    statusIndicator.style.color = '#1e40af';
                } else if (taskStatus === 'approved') {
                    statusIndicator.innerHTML = '‚úÖ Approved (Materials Ready)';
                    statusIndicator.style.background = '#dcfce7';
                    statusIndicator.style.color = '#166534';
                } else if (taskStatus === 'on_hold') {
                    statusIndicator.innerHTML = '‚è∏Ô∏è On Hold';
                    statusIndicator.style.background = '#fef3c7';
                    statusIndicator.style.color = '#92400e';
                } else if (taskStatus === 'inspected' || taskStatus === 'completed') {
                    statusIndicator.innerHTML = '‚úÖ Inspection Completed';
                    statusIndicator.style.background = '#d1fae5';
                    statusIndicator.style.color = '#065f46';
                }
                
                // Populate remarks history dynamically
                populateRemarksHistory(ticket);
                
                if (hasEngineer) {
                    document.getElementById('currentAssignment').style.display = 'block';
                    document.getElementById('assignedEngineer').textContent = ticket.engineer;
                    
                    // Show PM remarks if available
                    if (ticket.pmRemarks) {
                        document.getElementById('currentPMRemarks').style.display = 'block';
                        document.getElementById('pmRemarksDisplay').textContent = ticket.pmRemarks;
                    }
                }
                
                // Show Mark as Done button (always show to allow PM to notify FO)
                document.getElementById('markDoneBtn2').style.display = 'inline-flex';
                
                // Show On Hold button (hide if task is completed)
                if (taskStatus !== 'completed') {
                    document.getElementById('onHoldBtn').style.display = 'inline-flex';
                }
            } else if (status === 'completed') {
                // Completed appointments - view only, can delete
                document.getElementById('deleteBtn').style.display = 'inline-flex';
                if (hasEngineer) {
                    document.getElementById('currentAssignment').style.display = 'block';
                    document.getElementById('assignedEngineer').textContent = ticket.engineer;
                    
                    // Show PM remarks if available
                    if (ticket.pmRemarks) {
                        document.getElementById('currentPMRemarks').style.display = 'block';
                        document.getElementById('pmRemarksDisplay').textContent = ticket.pmRemarks;
                    }
                }
            } else if (status === 'rejected') {
                // Rejected appointments - can only delete
                document.getElementById('deleteBtn').style.display = 'inline-flex';
            }
        }
        
        function populateRemarksHistory(ticket) {
            const remarksHistory = document.getElementById('remarksHistory');
            if (!remarksHistory) return;
            
            let remarksHTML = '';
            const taskStatus = ticket.taskStatus || '';
            
            // Engineer initial remark (if exists)
            if (ticket.engineerRemarks) {
                remarksHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: white; border-left: 3px solid #3b82f6; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <span style="font-weight: 600; color: #1f2937; font-size: 13px;">Engineer</span>
                            <span style="font-size: 11px; color: #9ca3af;">Oct 14, 2025, 10:30 AM</span>
                        </div>
                        <div style="color: #374151; font-size: 13px; line-height: 1.5;">${ticket.engineerRemarks}</div>
                    </div>
                `;
            }
            
            // Asset Management remark (if approved) - Skip for inspected status
            if (taskStatus !== 'inspected' && ticket.assetStatus === 'approved' && ticket.assetReason) {
                remarksHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: white; border-left: 3px solid #10b981; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <span style="font-weight: 600; color: #1f2937; font-size: 13px;">Asset Management</span>
                            <span style="font-size: 11px; color: #9ca3af;">Oct 14, 2025, 11:15 AM</span>
                        </div>
                        <div style="color: #374151; font-size: 13px; line-height: 1.5;">${ticket.assetReason}</div>
                    </div>
                `;
            }
            
            // Project Manager remark (if exists) - Skip for inspected and approved status
            if (taskStatus !== 'inspected' && taskStatus !== 'approved' && ticket.pmRemarks) {
                let statusLabel = '';
                let borderColor = '#8b5cf6'; // Purple default
                
                if (taskStatus === 'approved') {
                    statusLabel = ' - Approved';
                    borderColor = '#10b981'; // Green
                } else if (taskStatus === 'on_hold') {
                    statusLabel = ' - On Hold';
                    borderColor = '#f59e0b'; // Yellow/Orange
                } else if (taskStatus === 'completed') {
                    statusLabel = ' - Completed';
                    borderColor = '#10b981'; // Green
                } else if (taskStatus === 'in_progress') {
                    statusLabel = ' - In Progress';
                    borderColor = '#3b82f6'; // Blue
                }
                
                remarksHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: white; border-left: 3px solid ${borderColor}; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <span style="font-weight: 600; color: #1f2937; font-size: 13px;">Project Manager${statusLabel}</span>
                            <span style="font-size: 11px; color: #9ca3af;">Oct 14, 2025, 11:30 AM</span>
                        </div>
                        <div style="color: #374151; font-size: 13px; line-height: 1.5;">${ticket.pmRemarks}</div>
                    </div>
                `;
            }
            
            // Show default message if no remarks
            if (!remarksHTML) {
                remarksHTML = '<div style="color: #6b7280; font-size: 13px; text-align: center; padding: 20px;">No remarks yet. Updates will appear here as the task progresses.</div>';
            }
            
            remarksHistory.innerHTML = remarksHTML;
        }

        window.closeTicketOverviewModal = function() {
            const modal = document.getElementById('ticketOverviewModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };

        // Action functions for ticket overview modal
        window.processTicket = function() {
            // Check if engineer is selected for pending tickets
            const select = document.getElementById('engineerSelect');
            const engineerId = select ? select.value : '';
            
            if (!engineerId) { 
                alert('Please select an engineer before processing the ticket.'); 
                return; 
            }
            
            const engineers = JSON.parse(localStorage.getItem('engineers') || '[]');
            const engineer = engineers.find(e => e.id === engineerId);
            
            if (!engineer) {
                alert('Selected engineer not found.');
                return;
            }
            
            // Get PM remarks
            const pmRemarks = document.getElementById('pmRemarksText').value.trim();
            
            if (confirm(`Process this ticket and assign it to ${engineer.givenName} ${engineer.lastName}? The ticket will be moved to "In Progress" status.`)) {
                // In a real system, save the pmRemarks with the ticket
                const remarkMessage = pmRemarks ? `\n\nPM Remarks: ${pmRemarks}` : '';
                alert(`Ticket has been processed and assigned to ${engineer.givenName} ${engineer.lastName}. Status changed to In Progress.${remarkMessage}`);
                closeTicketOverviewModal();
                // Refresh the tables
                loadData();
                renderRequestAppointments(state.requestAppointmentsFiltered);
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
            }
        };

        window.approveTicket = function() {
            if (confirm('Approve this ticket?')) {
                alert('Ticket has been approved.');
                closeTicketOverviewModal();
                // Refresh the tables
                loadData();
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
                renderApprovedAppointments(state.approvedAppointmentsFiltered);
            }
        };
        
        window.notifyFOApprove = function() {
            const ticketNum = document.getElementById('overviewTicket').textContent;
            const site = document.getElementById('overviewSite').textContent;
            const date = document.getElementById('overviewDate').textContent;
            
            if (confirm(`Notify Facility Owner that appointment ${ticketNum} has been approved?\n\nSite: ${site}\nDate: ${date}`)) {
                alert('Facility Owner has been notified of the approval. The appointment status will be updated.');
                closeTicketOverviewModal();
                // Refresh the tables
                loadData();
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
                renderApprovedAppointments(state.approvedAppointmentsFiltered);
            }
        };
        
        window.notifyFOReject = function() {
            const ticketNum = document.getElementById('overviewTicket').textContent;
            const reason = document.getElementById('rejectionReasonText').value.trim();
            
            if (!reason) {
                alert('Please provide a reason for rejection.');
                return;
            }
            
            if (confirm(`Notify Facility Owner that appointment ${ticketNum} has been rejected?\n\nReason: ${reason}`)) {
                alert('Facility Owner has been notified of the rejection with the provided reason.');
                closeTicketOverviewModal();
                // Refresh the tables
                loadData();
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
                renderRejectedAppointments(state.rejectedAppointmentsFiltered);
            }
        };

        window.rejectTicket = function() {
            if (confirm('Reject this ticket?')) {
                alert('Ticket has been rejected.');
                closeTicketOverviewModal();
                // Refresh the tables
                loadData();
                renderRequestAppointments(state.requestAppointmentsFiltered);
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
                renderRejectedAppointments(state.rejectedAppointmentsFiltered);
            }
        };

        window.deleteTicket = function() {
            if (confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
                alert('Ticket has been deleted.');
                closeTicketOverviewModal();
                // Refresh the tables
                loadData();
                renderApprovedAppointments(state.approvedAppointmentsFiltered);
                renderRejectedAppointments(state.rejectedAppointmentsFiltered);
            }
        };
        
        window.markAsDone = function() {
            const ticketNum = document.getElementById('overviewTicket').textContent;
            const foRemarks = document.getElementById('foRemarkText').value.trim();
            
            if (!foRemarks) {
                alert('Please provide remarks to the Facility Owner before marking as done.');
                return;
            }
            
            if (confirm(`Mark appointment ${ticketNum} as DONE?\n\nRemarks to Facility Owner: ${foRemarks}\n\nThis will update the status and notify the Facility Owner.`)) {
                alert('Appointment marked as DONE. The Facility Owner will see the updated status with your remarks.');
                closeTicketOverviewModal();
                // In a real system, this would update the appointment status to 'done'
                // and store the remarks for the facility owner
                loadData();
                renderApprovedAppointments(state.approvedAppointmentsFiltered);
            }
        };
        
        // On Hold Functions
        window.showOnHoldInput = function() {
            const onHoldSection = document.getElementById('onHoldRemarksSection');
            if (onHoldSection) {
                onHoldSection.style.display = 'block';
                // Scroll to the section
                onHoldSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };
        
        window.cancelOnHold = function() {
            const onHoldSection = document.getElementById('onHoldRemarksSection');
            const onHoldReasonText = document.getElementById('onHoldReasonText');
            if (onHoldSection) {
                onHoldSection.style.display = 'none';
            }
            if (onHoldReasonText) {
                onHoldReasonText.value = '';
            }
        };
        
        window.confirmOnHold = function() {
            const onHoldReason = document.getElementById('onHoldReasonText').value.trim();
            const ticketNum = document.getElementById('overviewTicket').textContent;
            
            if (!onHoldReason) {
                alert('Please provide a reason for putting this appointment on hold.');
                return;
            }
            
            if (confirm(`Put appointment ${ticketNum} on hold?\n\nReason: ${onHoldReason}\n\nThis will notify the Facility Owner.`)) {
                alert('Appointment has been put on hold. The Facility Owner has been notified with the reason.');
                closeTicketOverviewModal();
                // In a real system, this would update the appointment status
                loadData();
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
            }
        };
        
        window.closeAssignmentForm = function() {
            const modal = document.getElementById('assignmentModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };
    </script>
    <script>
        // Local state management (no backend)
        const state = { 
            accounts: [],
            accountsFiltered: [],
            requests: [], 
            approved: [],
            engineers: [],
            engineersFiltered: [],
            requestsFiltered: [],
            approvedFiltered: [],
            appointments: [],
            requestAppointments: [],
            onHoldAppointments: [],
            approvedAppointments: [],
            rejectedAppointments: [],
            requestAppointmentsFiltered: [],
            onHoldAppointmentsFiltered: [],
            approvedAppointmentsFiltered: [],
            rejectedAppointmentsFiltered: [],
            facilityOwners: [],
            facilityOwnersFiltered: []
        };

        // Load data from localStorage
        function loadData() {
            try {
                // Force reload dummy data (UI-only)
                let engineers = seedDummyEngineers();
                localStorage.setItem('engineers', JSON.stringify(engineers));
                
                let companies = seedDummyFacilityOwners();
                localStorage.setItem('companies', JSON.stringify(companies));
                
                // Use hardcoded appointments for UI
                const hardcoded = getHardcodedAppointments();
                const appointments = ([]).concat(
                    hardcoded.request,
                    hardcoded.onhold,
                    hardcoded.approved,
                    hardcoded.rejected
                );
                
                state.accounts = companies;
                state.accountsFiltered = companies.slice();
                state.requests = companies.filter(a => (a.status || 'pending').toLowerCase() !== 'approved');
                state.approved = companies.filter(a => (a.status || 'pending').toLowerCase() === 'approved');
                state.requestsFiltered = state.requests.slice();
                state.approvedFiltered = state.approved.slice();
                state.engineers = engineers;
                state.engineersFiltered = engineers.slice();
                state.facilityOwners = companies.filter(a => (a.status || 'pending').toLowerCase() === 'approved');
                state.facilityOwnersFiltered = state.facilityOwners.slice();
                
                state.appointments = appointments;
                state.requestAppointments = hardcoded.request.slice();
                state.onHoldAppointments = hardcoded.onhold.slice();
                state.approvedAppointments = hardcoded.approved.slice();
                state.rejectedAppointments = hardcoded.rejected.slice();
                state.requestAppointmentsFiltered = state.requestAppointments.slice();
                state.onHoldAppointmentsFiltered = state.onHoldAppointments.slice();
                state.approvedAppointmentsFiltered = state.approvedAppointments.slice();
                state.rejectedAppointmentsFiltered = state.rejectedAppointments.slice();
            } catch (e) {
                console.warn('Failed to load data:', e);
            }
        }

        // Render functions
        function renderEngineers(items) {
            const tbody = document.getElementById('engineersBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((eng, index) => `
<tr data-id="${eng.id}">
  <td>${index + 1}</td>
  <td>${eng.givenName || ''}</td>
  <td>${eng.middleName || ''}</td>
  <td>${eng.lastName || ''}</td>
  <td>${eng.phoneNumber || ''}</td>
  <td>${eng.email || ''}</td>
  <td>${eng.location || 'N/A'}</td>
  <td>${eng.password || ''}</td>
  <td><button class="action-btn" onclick="editEngineer('${eng.id}')">Edit</button></td>
</tr>`).join('');
        }

        function renderFacilityOwners(items) {
            const tbody = document.getElementById('facilityOwnersBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((fo, index) => {
                const givenName = fo.firstName || fo.givenName || 'N/A';
                const lastName = fo.lastName || 'N/A';
                const middleName = fo.middleName || 'N/A';
                return `
<tr data-id="${fo.id}">
  <td>${index + 1}</td>
  <td>${givenName}</td>
  <td>${middleName}</td>
  <td>${lastName}</td>
  <td>${fo.companyName || 'N/A'}</td>
  <td>${fo.phone || fo.phoneNumber || 'N/A'}</td>
  <td>${fo.companyEmail || fo.email || 'N/A'}</td>
  <td>${fo.location || 'N/A'}</td>
  <td>${fo.password || 'N/A'}</td>
  <td><button class="action-btn" onclick="editFacilityOwner('${fo.id}')">Edit</button></td>
</tr>`;
            }).join('');
        }

        function renderRequests(items) {
            const tbody = document.getElementById('requestsBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((acc, index) => {
                const givenName = acc.firstName || acc.givenName || 'N/A';
                const lastName = acc.lastName || 'N/A';
                const middleName = acc.middleName || 'N/A';
                
                return `
<tr data-id="${acc.id}">
  <td>${index + 1}</td>
  <td>${givenName}</td>
  <td>${middleName}</td>
  <td>${lastName}</td>
  <td>${acc.phoneNumber || acc.phone || 'N/A'}</td>
  <td>${acc.companyEmail || acc.email || 'N/A'}</td>
  <td>${acc.companyName || 'N/A'}</td>
  <td><button class="action-btn" onclick="approveAccount('${acc.id}')">Approve</button></td>
</tr>`;
            }).join('');
        }

        function renderApproved(items) {
            const tbody = document.getElementById('approvedBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((acc, index) => {
                const givenName = acc.firstName || acc.givenName || 'N/A';
                const lastName = acc.lastName || 'N/A';
                const middleName = acc.middleName || 'N/A';
                
                return `
<tr data-id="${acc.id}">
  <td>${index + 1}</td>
  <td>${givenName}</td>
  <td>${middleName}</td>
  <td>${lastName}</td>
  <td>${acc.phoneNumber || acc.phone || 'N/A'}</td>
  <td>${acc.companyEmail || acc.email || 'N/A'}</td>
  <td>${acc.companyName || 'N/A'}</td>
  <td><button class="action-btn delete" onclick="deleteAccount('${acc.id}')">Delete</button></td>
</tr>`;
            }).join('');
        }

        function renderRequestAppointments(items) {
            const tbody = document.getElementById('requestAppointmentsBody');
            if (!tbody) return;
            const engineerOptions = (state.engineers || []).map(e => `<option value="${e.id}">${e.givenName || ''} ${e.lastName || ''}</option>`).join('');
            tbody.innerHTML = items.map((apt, index) => `
<tr data-id="${apt.id}">
  <td>${index + 1}</td>
  <td>${apt.ticketNumber || 'TKT-' + apt.id}</td>
  <td>${apt.date || 'N/A'}</td>
  <td>${apt.site || 'N/A'}</td>
  <td>${apt.type || 'N/A'}</td>
  <td>${apt.description || 'N/A'}</td>
  <td><span class="status-${(apt.status || 'pending').toLowerCase()}">${apt.status || 'Pending'}</span></td>
  <td><span class="priority-${(apt.priority || 'low').toLowerCase()}">${apt.priority || 'Low'}</span></td>
  <td>
    <select class="assign-engineer" data-apt="${apt.id}">
      <option value="">Select engineer‚Ä¶</option>
      ${engineerOptions}
    </select>
  </td>
  <td><div class="row-actions"><button class="action-btn" onclick="processAppointment('${apt.id}', true)">Process</button><button class="action-btn delete" onclick="rejectAppointment('${apt.id}')">Reject</button></div></td>
</tr>`).join('');
        }

        function renderOnHoldAppointments(items) {
            const tbody = document.getElementById('onHoldAppointmentsBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((apt, index) => {
                const taskStatus = apt.taskStatus || 'in_progress';
                let taskStatusClass = '';
                let taskStatusText = '';
                let taskIcon = '';
                let bgColor = '';
                let textColor = '';
                
                if (taskStatus === 'pending') {
                    taskStatusClass = 'status-pending';
                    taskStatusText = 'Pending';
                    taskIcon = '‚è≥';
                    bgColor = '#fef3c7';
                    textColor = '#92400e';
                } else if (taskStatus === 'in_progress') {
                    taskStatusClass = 'status-in-progress';
                    taskStatusText = 'Ongoing';
                    taskIcon = 'üîÑ';
                    bgColor = '#dbeafe';
                    textColor = '#1e40af';
                } else if (taskStatus === 'approved') {
                    taskStatusClass = 'status-approved';
                    taskStatusText = 'Approved';
                    taskIcon = '‚úÖ';
                    bgColor = '#dcfce7';
                    textColor = '#166534';
                } else if (taskStatus === 'inspected') {
                    taskStatusClass = 'status-inspected';
                    taskStatusText = 'Mark as Inspected';
                    taskIcon = '‚úÖ';
                    bgColor = '#d1fae5';
                    textColor = '#065f46';
                } else if (taskStatus === 'completed') {
                    taskStatusClass = 'status-completed';
                    taskStatusText = 'Completed';
                    taskIcon = '‚úÖ';
                    bgColor = '#d1fae5';
                    textColor = '#065f46';
                } else if (taskStatus === 'on_hold') {
                    taskStatusClass = 'status-on-hold';
                    taskStatusText = 'On Hold';
                    taskIcon = '‚è∏Ô∏è';
                    bgColor = '#fef3c7';
                    textColor = '#92400e';
                }
                
                return `
<tr data-id="${apt.id}">
  <td>${index + 1}</td>
  <td>${apt.ticketNumber || 'TKT-' + apt.id}</td>
  <td>${apt.date || 'N/A'}</td>
  <td>${apt.site || 'N/A'}</td>
  <td>${apt.type || 'N/A'}</td>
  <td>${apt.description || 'N/A'}</td>
  <td><span class="${taskStatusClass}" style="padding: 4px 8px; border-radius: 6px; font-size: 12px; display: inline-block; background: ${bgColor}; color: ${textColor}; font-weight: 600;">${taskIcon} ${taskStatusText}</span></td>
  <td><span class="priority-${(apt.priority || 'low').toLowerCase()}">${apt.priority || 'Low'}</span></td>
  <td>${apt.engineer || '‚è≥'}</td>
  <td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('${apt.id}')">View</button></div></td>
</tr>`;
            }).join('');
        }

        function renderApprovedAppointments(items) {
            const tbody = document.getElementById('approvedAppointmentsBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((apt, index) => {
                const priorityClass = (apt.priority || 'low').toLowerCase();
                const priorityColors = {
                    'low': '#10b981',
                    'medium': '#f59e0b',
                    'high': '#ef4444'
                };
                const priorityColor = priorityColors[priorityClass] || '#10b981';
                
                return `
<tr data-id="${apt.id}">
  <td>${index + 1}</td>
  <td>${apt.ticketNumber || 'TKT-' + apt.id}</td>
  <td>${apt.date || 'N/A'}</td>
  <td>${apt.site || 'N/A'}</td>
  <td>${apt.type || 'N/A'}</td>
  <td>${apt.description || 'N/A'}</td>
  <td><span class="status-badge status-completed">‚úÖ Completed</span></td>
  <td><span class="priority-badge" style="color: ${priorityColor}; font-weight: 700;">${apt.priority || 'Low'}</span></td>
  <td>${apt.engineer || 'N/A'}</td>
</tr>`;
            }).join('');
        }

        function renderRejectedAppointments(items) {
            const tbody = document.getElementById('rejectedAppointmentsBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((apt, index) => `
<tr data-id="${apt.id}">
  <td>${index + 1}</td>
  <td>${apt.ticketNumber || 'TKT-' + apt.id}</td>
  <td>${apt.date || 'N/A'}</td>
  <td>${apt.site || 'N/A'}</td>
  <td>${apt.type || 'N/A'}</td>
  <td>${apt.description || 'N/A'}</td>
  <td><span class="status-rejected">Rejected</span></td>
  <td><span class="priority-${(apt.priority || 'low').toLowerCase()}">${apt.priority || 'Low'}</span></td>
  <td><div class="row-actions"><button class="action-btn delete" onclick="deleteAppointment('${apt.id}')">Delete</button></div></td>
</tr>`).join('');
        }

        function renderAccounts(items) {
            const tbody = document.getElementById('accountsBody');
            if (!tbody) return;
            tbody.innerHTML = items.map((acc, index) => {
                const status = (acc.status || 'pending').toLowerCase();
                let statusBadge = '';
                
                if (status === 'pending') {
                    statusBadge = '<span class="status-badge" style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; white-space: nowrap;">‚è≥ Pending</span>';
                } else if (status === 'approved') {
                    statusBadge = '<span class="status-badge" style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; white-space: nowrap;">‚úÖ Approved</span>';
                } else if (status === 'rejected') {
                    statusBadge = '<span class="status-badge" style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; white-space: nowrap;">‚ùå Rejected</span>';
                }
                
                const fullName = `${acc.firstName || ''} ${acc.middleName || ''} ${acc.lastName || ''}`.trim();
                const displayPassword = acc.password || '‚Äî';
                
                return `
<tr data-id="${acc.id}">
  <td style="text-align: center; font-weight: 600; font-size: 11px; color: #6b7280;">${acc.id}</td>
  <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${fullName}">${fullName || 'N/A'}</td>
  <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${acc.companyName || 'N/A'}">${acc.companyName || 'N/A'}</td>
  <td style="font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${acc.companyEmail || 'N/A'}">${acc.companyEmail || 'N/A'}</td>
  <td style="white-space: nowrap;">${acc.phone || 'N/A'}</td>
  <td style="font-family: monospace; font-size: 12px; color: #374151;">${displayPassword}</td>
  <td style="text-align: center;">${statusBadge}</td>
  <td style="text-align: center;"><button class="action-btn" onclick="viewAccountDetails('${acc.id}')" style="padding: 6px 12px; font-size: 12px;">View</button></td>
</tr>`;
            }).join('');
        }

        // Action functions for accounts
        function approveAccountStatus(id) {
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            const company = companies.find(c => c.id === id);
            if (company && confirm(`Approve account for ${company.firstName} ${company.lastName} from ${company.companyName}?`)) {
                company.status = 'approved';
                // Don't generate new password - use the one from registration
                localStorage.setItem('companies', JSON.stringify(companies));
                alert(`Account approved!\n\nAccount: ${company.companyEmail}\nPassword: ${company.password || 'Set by user during registration'}\n\nPlease notify the facility owner.`);
                loadData();
                filterAccounts();
            }
        }

        function rejectAccountStatus(id) {
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            const company = companies.find(c => c.id === id);
            if (company) {
                const reason = prompt('Enter rejection reason:');
                if (reason) {
                    company.status = 'rejected';
                    company.rejectionReason = reason;
                    localStorage.setItem('companies', JSON.stringify(companies));
                    alert(`Account rejected. Reason: ${reason}`);
                    loadData();
                    filterAccounts();
                }
            }
        }

        function viewAccountDetails(id) {
            const company = state.accounts.find(c => c.id === id);
            if (!company) return;
            
            // Populate modal with account details
            document.getElementById('accountDetailId').textContent = company.id;
            document.getElementById('accountDetailName').textContent = `${company.firstName} ${company.middleName || ''} ${company.lastName}`;
            document.getElementById('accountDetailCompany').textContent = company.companyName || 'N/A';
            document.getElementById('accountDetailEmail').textContent = company.companyEmail || 'N/A';
            document.getElementById('accountDetailPhone').textContent = company.phone || 'N/A';
            document.getElementById('accountDetailLocation').textContent = company.location || 'N/A';
            document.getElementById('accountDetailStatus').textContent = (company.status || 'pending').toUpperCase();
            document.getElementById('accountDetailCreated').textContent = company.createdAt ? new Date(company.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
            document.getElementById('accountDetailPassword').textContent = company.password || 'Not generated yet';
            
            const status = (company.status || 'pending').toLowerCase();
            const statusBadge = document.getElementById('accountDetailStatus');
            
            // Always show password row
            const passwordRow = document.getElementById('accountDetailPasswordRow');
            if (company.password) {
                passwordRow.style.display = 'flex';
            } else {
                passwordRow.style.display = 'none';
            }
            
            if (status === 'pending') {
                statusBadge.style.background = '#fef3c7';
                statusBadge.style.color = '#92400e';
                document.getElementById('accountApproveBtn').style.display = 'inline-flex';
                document.getElementById('accountRejectBtn').style.display = 'inline-flex';
                document.getElementById('accountDeleteBtn').style.display = 'none';
                document.getElementById('accountDetailRejectionRow').style.display = 'none';
            } else if (status === 'approved') {
                statusBadge.style.background = '#dcfce7';
                statusBadge.style.color = '#166534';
                document.getElementById('accountApproveBtn').style.display = 'none';
                document.getElementById('accountRejectBtn').style.display = 'none';
                document.getElementById('accountDeleteBtn').style.display = 'none';
                document.getElementById('accountDetailRejectionRow').style.display = 'none';
            } else if (status === 'rejected') {
                statusBadge.style.background = '#fee2e2';
                statusBadge.style.color = '#991b1b';
                document.getElementById('accountApproveBtn').style.display = 'none';
                document.getElementById('accountRejectBtn').style.display = 'none';
                document.getElementById('accountDeleteBtn').style.display = 'inline-flex';
                
                // Show rejection reason if available
                if (company.rejectionReason) {
                    document.getElementById('accountDetailRejectionReason').textContent = company.rejectionReason;
                    document.getElementById('accountDetailRejectionRow').style.display = 'flex';
                } else {
                    document.getElementById('accountDetailRejectionRow').style.display = 'none';
                }
            }
            
            // Store current account ID for actions
            window.currentAccountId = id;
            
            // Show modal
            document.getElementById('accountDetailModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeAccountDetailModal() {
            document.getElementById('accountDetailModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function approveAccountFromModal() {
            const id = window.currentAccountId;
            if (!id) return;
            
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            const company = companies.find(c => c.id === id);
            if (company && confirm(`Approve account for ${company.firstName} ${company.lastName} from ${company.companyName}?`)) {
                company.status = 'approved';
                // Don't generate new password - use the one from registration
                localStorage.setItem('companies', JSON.stringify(companies));
                alert(`Account approved!\n\nAccount: ${company.companyEmail}\nPassword: ${company.password || 'Set by user during registration'}\n\nPlease notify the facility owner.`);
                loadData();
                filterAccounts();
                closeAccountDetailModal();
            }
        }

        function rejectAccountFromModal() {
            const id = window.currentAccountId;
            if (!id) return;
            
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            const company = companies.find(c => c.id === id);
            if (company) {
                const reason = prompt('Enter rejection reason:');
                if (reason) {
                    company.status = 'rejected';
                    company.rejectionReason = reason;
                    localStorage.setItem('companies', JSON.stringify(companies));
                    alert(`Account rejected. Reason: ${reason}`);
                    loadData();
                    filterAccounts();
                    closeAccountDetailModal();
                }
            }
        }

        function deleteAccountFromModal() {
            const id = window.currentAccountId;
            if (!id) return;
            
            if (confirm('Are you sure you want to permanently delete this account?')) {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const filtered = companies.filter(c => c.id !== id);
                localStorage.setItem('companies', JSON.stringify(filtered));
                loadData();
                filterAccounts();
                closeAccountDetailModal();
            }
        }

        function deleteAccountPermanent(id) {
            if (confirm('Are you sure you want to permanently delete this account?')) {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const filtered = companies.filter(c => c.id !== id);
                localStorage.setItem('companies', JSON.stringify(filtered));
                loadData();
                filterAccounts();
            }
        }

        function generatePassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$';
            let password = '';
            for (let i = 0; i < 10; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function approveAccount(id) {
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            const company = companies.find(c => c.id === id);
            if (company) {
                company.status = 'approved';
                localStorage.setItem('companies', JSON.stringify(companies));
                loadData();
                renderRequests(state.requestsFiltered);
                renderApproved(state.approvedFiltered);
            }
        }

        function deleteAccount(id) {
            if (confirm('Are you sure you want to delete this account?')) {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const filtered = companies.filter(c => c.id !== id);
                localStorage.setItem('companies', JSON.stringify(filtered));
                loadData();
                renderRequests(state.requestsFiltered);
                renderApproved(state.approvedFiltered);
            }
        }

        function editFacilityOwner(id) {
            const fo = (state.facilityOwners || []).find(f => f.id === id);
            if (!fo) return;
            document.getElementById('foModalTitle').textContent = 'Edit Facility Owner';
            document.getElementById('foHiddenId').value = fo.id || '';
            document.getElementById('foEditGivenName').value = fo.firstName || fo.givenName || '';
            document.getElementById('foEditMiddleName').value = fo.middleName || '';
            document.getElementById('foEditLastName').value = fo.lastName || '';
            document.getElementById('foEditOrganization').value = fo.companyName || '';
            document.getElementById('foEditContact').value = fo.phone || fo.phoneNumber || '';
            document.getElementById('foEditEmail').value = fo.companyEmail || fo.email || '';
            document.getElementById('foEditLocation').value = fo.location || '';
            document.getElementById('foEditPassword').value = fo.password || '';
            document.getElementById('facilityOwnerModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.getElementById('facilityOwnerForm').onsubmit = window.saveFacilityOwner;
            // Show delete button in Edit mode
            const delBtn = document.getElementById('foDeleteBtn');
            if (delBtn) {
                delBtn.style.display = '';
                delBtn.onclick = function(){ window.deleteFacilityOwner(fo.id); };
            }
        }

        function deleteFacilityOwner(id) {
            if (confirm('Are you sure you want to delete this facility owner account?')) {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const filtered = companies.filter(c => c.id !== id);
                localStorage.setItem('companies', JSON.stringify(filtered));
                loadData();
                renderFacilityOwners(state.facilityOwnersFiltered);
                closeFacilityOwnerModal();
            }
        }

        function saveFacilityOwner(ev) {
            ev.preventDefault();
            const idHidden = document.getElementById('foHiddenId').value.trim();
            const facilityOwner = {
                id: idHidden || ('FO-' + Math.random().toString(36).slice(2,8).toUpperCase()),
                firstName: document.getElementById('foEditGivenName').value.trim(),
                middleName: document.getElementById('foEditMiddleName').value.trim(),
                lastName: document.getElementById('foEditLastName').value.trim(),
                companyName: document.getElementById('foEditOrganization').value.trim(),
                phone: document.getElementById('foEditContact').value.trim(),
                companyEmail: document.getElementById('foEditEmail').value.trim(),
                location: document.getElementById('foEditLocation').value.trim(),
                password: document.getElementById('foEditPassword').value,
                status: 'approved',
                createdAt: new Date().toISOString()
            };
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            const idx = companies.findIndex(c => c.id === (idHidden || facilityOwner.id));
            if (idx >= 0) {
                companies[idx] = facilityOwner;
            } else {
                companies.push(facilityOwner);
            }
            localStorage.setItem('companies', JSON.stringify(companies));
            loadData();
            renderFacilityOwners(state.facilityOwnersFiltered);
            closeFacilityOwnerModal();
        }

        function closeFacilityOwnerModal() {
            document.getElementById('facilityOwnerModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function processAppointment(id, requireEngineer) {
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const apt = appointments.find(a => a.id === id);
            if (apt) {
                if (requireEngineer) {
                    const select = document.querySelector(`select.assign-engineer[data-apt="${id}"]`);
                    const engineerId = select ? select.value : '';
                    if (!engineerId) { alert('Please assign an engineer before processing.'); return; }
                    const engList = JSON.parse(localStorage.getItem('engineers') || '[]');
                    const eng = engList.find(e => e.id === engineerId);
                    apt.engineer = eng ? `${eng.givenName || ''} ${eng.lastName || ''}`.trim() : engineerId;
                }
                apt.status = 'on hold';
                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadData();
                renderRequestAppointments(state.requestAppointmentsFiltered);
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
            }
        }

        function approveAppointment(id) {
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const apt = appointments.find(a => a.id === id);
            if (apt) {
                apt.status = 'approved';
                localStorage.setItem('appointments', JSON.stringify(appointments));
                loadData();
                renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
                renderApprovedAppointments(state.approvedAppointmentsFiltered);
            }
        }

        function rejectAppointment(id) {
            if (confirm('Reject this appointment request?')) {
                const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const apt = appointments.find(a => a.id === id);
                if (apt) {
                    apt.status = 'rejected';
                    localStorage.setItem('appointments', JSON.stringify(appointments));
                    loadData();
                    renderRequestAppointments(state.requestAppointmentsFiltered);
                    renderRejectedAppointments(state.rejectedAppointmentsFiltered);
                }
            }
        }

        function deleteAppointment(id) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const filtered = appointments.filter(a => a.id !== id);
                localStorage.setItem('appointments', JSON.stringify(filtered));
                loadData();
                renderApprovedAppointments(state.approvedAppointmentsFiltered);
                renderRejectedAppointments(state.rejectedAppointmentsFiltered);
            }
        }

        // Calendar functionality
        let currentDate = new Date();
        
        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            let calendarHTML = `
                <div class="calendar-day">S</div>
                <div class="calendar-day">M</div>
                <div class="calendar-day">T</div>
                <div class="calendar-day">W</div>
                <div class="calendar-day">TH</div>
                <div class="calendar-day">F</div>
                <div class="calendar-day">S</div>
            `;
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="calendar-date"></div>';
            }
            
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const selectedClass = isToday ? 'selected' : '';
                calendarHTML += `<div class="calendar-date ${selectedClass}">${day}</div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = calendarHTML;
        }

        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const viewSections = document.querySelectorAll('.view-section');
            const appointmentsCaret = document.querySelector('[data-toggle="appointments"]');
            const appointmentsSubnav = document.getElementById('appointments-subnav');
            const accountsCaret = document.querySelector('[data-toggle="accounts"]');
            const accountsSubnav = document.getElementById('accounts-subnav');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    viewSections.forEach(section => section.classList.remove('active'));
                    if (link.hasAttribute('data-view')) {
                        navLinks.forEach(nav => nav.classList.remove('active'));
                        link.classList.add('active');
                        const viewName = link.getAttribute('data-view');
                        const targetView = document.getElementById(viewName + '-view');
                        if (targetView) targetView.classList.add('active');
                    }
                });
            });

            // Handle Appointments dropdown
            if (appointmentsCaret && appointmentsSubnav) {
                appointmentsCaret.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isOpen = appointmentsSubnav.style.display !== 'none';
                    appointmentsSubnav.style.display = isOpen ? 'none' : 'block';
                });
            }
            
            // Handle Accounts dropdown
            if (accountsCaret && accountsSubnav) {
                accountsCaret.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isOpen = accountsSubnav.style.display !== 'none';
                    accountsSubnav.style.display = isOpen ? 'none' : 'block';
                });
            }
        }

        function updateDashboardStats() {
            const totalTickets = state.appointments.length;
            const pendingApprovals = state.requests.length;
            const rejectedTasks = state.rejectedAppointments.length;
            const pendingFOAccounts = state.accounts.filter(acc => (acc.status || 'pending').toLowerCase() === 'pending').length;
            
            const totalEl = document.getElementById('totalTickets');
            if (totalEl) totalEl.textContent = totalTickets;
            const pendingEl = document.getElementById('pendingApprovals');
            if (pendingEl) pendingEl.textContent = pendingApprovals;
            const rejectedEl = document.getElementById('rejectedTasks');
            if (rejectedEl) rejectedEl.textContent = rejectedTasks;
            const pendingFOEl = document.getElementById('pendingFOAccounts');
            if (pendingFOEl) pendingFOEl.textContent = pendingFOAccounts;
        }

        function navigateToAccounts(filterStatus) {
            // Switch to account management view
            const viewSections = document.querySelectorAll('.view-section');
            viewSections.forEach(section => section.classList.remove('active'));
            const accountsView = document.getElementById('account-management-view');
            if (accountsView) accountsView.classList.add('active');
            
            // Update navigation active state
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(nav => nav.classList.remove('active'));
            const accountsNavLink = document.querySelector('[data-view="account-management"]');
            if (accountsNavLink) accountsNavLink.classList.add('active');
            
            // Open the accounts dropdown
            const accountsSubnav = document.getElementById('accounts-subnav');
            if (accountsSubnav) accountsSubnav.style.display = 'block';
            
            // Set the filter
            const statusFilter = document.getElementById('accountStatusFilter');
            if (statusFilter && filterStatus) {
                statusFilter.value = filterStatus;
                filterAccounts();
            }
        }

        // Filter accounts function
        function filterAccounts() {
            const statusFilter = document.getElementById('accountStatusFilter').value;
            const searchQuery = document.getElementById('searchAccounts').value.toLowerCase();
            
            state.accountsFiltered = state.accounts.filter(acc => {
                const statusMatch = statusFilter === 'all' || (acc.status || 'pending').toLowerCase() === statusFilter;
                const searchMatch = !searchQuery || [
                    acc.firstName, acc.middleName, acc.lastName, acc.companyName, 
                    acc.companyEmail, acc.phone, acc.location
                ].join(' ').toLowerCase().includes(searchQuery);
                
                return statusMatch && searchMatch;
            });
            
            renderAccounts(state.accountsFiltered);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            // Render accounts table
            renderAccounts(state.accountsFiltered);
            renderEngineers(state.engineersFiltered);
            renderFacilityOwners(state.facilityOwnersFiltered);
            renderRequestAppointments(state.requestAppointmentsFiltered);
            renderOnHoldAppointments(state.onHoldAppointmentsFiltered);
            renderApprovedAppointments(state.approvedAppointmentsFiltered);
            renderRejectedAppointments(state.rejectedAppointmentsFiltered);
            updateDashboardStats();
            initNavigation();
            updateCalendar();

            // Default to dashboard; when user clicks a sub-view, show that view
            const defaultView = document.getElementById('dashboard-view');
            if (defaultView) defaultView.classList.add('active');
            
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
            });
            
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
            });

            // Engineers initialization
            const engSearch = document.getElementById('searchEngineers');
            if (engSearch) {
                engSearch.addEventListener('input', () => {
                    const q = engSearch.value.toLowerCase();
                    state.engineersFiltered = state.engineers.filter(e => {
                        const hay = [e.id, e.givenName, e.middleName, e.lastName, e.phoneNumber, e.email, e.location].join(' ').toLowerCase();
                        return hay.includes(q);
                    });
			renderEngineers(state.engineersFiltered);
                });
            }

            // Accounts filter and search
            const accountStatusFilter = document.getElementById('accountStatusFilter');
            const accountSearch = document.getElementById('searchAccounts');
            
            if (accountStatusFilter) {
                accountStatusFilter.addEventListener('change', filterAccounts);
            }
            
            if (accountSearch) {
                accountSearch.addEventListener('input', filterAccounts);
            }

            // Facility Owners search
            const foSearch = document.getElementById('searchFacilityOwners');
            if (foSearch) {
                foSearch.addEventListener('input', () => {
                    const q = foSearch.value.toLowerCase();
                    state.facilityOwnersFiltered = state.facilityOwners.filter(fo => {
                        const hay = [fo.id, fo.firstName, fo.givenName, fo.middleName, fo.lastName, fo.companyName, fo.phone, fo.phoneNumber, fo.companyEmail, fo.email, fo.location].join(' ').toLowerCase();
                        return hay.includes(q);
                    });
                    renderFacilityOwners(state.facilityOwnersFiltered);
                });
            }

            // In Progress Appointments status filter and search
            const statusFilterOnHold = document.getElementById('statusFilterOnHold');
            const searchOnHold = document.getElementById('searchOnHoldAppointments');
            
            function filterOnHoldAppointments() {
                const statusFilter = statusFilterOnHold ? statusFilterOnHold.value : 'all';
                const searchQuery = searchOnHold ? searchOnHold.value.toLowerCase() : '';
                
                const hardcoded = getHardcodedAppointments();
                let filtered = hardcoded.onhold.filter(apt => {
                    const statusMatch = statusFilter === 'all' || (apt.taskStatus || 'in_progress') === statusFilter;
                    const searchMatch = !searchQuery || 
                        [apt.ticketNumber, apt.date, apt.site, apt.type, apt.description, apt.engineer].join(' ').toLowerCase().includes(searchQuery);
                    return statusMatch && searchMatch;
                });
                
                renderOnHoldAppointments(filtered);
            }
            
            if (statusFilterOnHold) {
                statusFilterOnHold.addEventListener('change', filterOnHoldAppointments);
            }
            
            if (searchOnHold) {
                searchOnHold.addEventListener('input', filterOnHoldAppointments);
            }

            // Wire FO create form
            const foForm = document.getElementById('foCreateForm');
            if (foForm) {
                foForm.addEventListener('submit', function(ev){
                    ev.preventDefault();
                    const given = document.getElementById('foGivenName').value.trim();
                    const middle = document.getElementById('foMiddleName').value.trim();
                    const last = document.getElementById('foLastName').value.trim();
                    const org = document.getElementById('foOrganization').value.trim();
                    const phone = document.getElementById('foContact').value.trim();
                    const email = document.getElementById('foEmail').value.trim();
                    const location = document.getElementById('foLocation').value.trim();
                    if (!given || !last || !org || !phone || !email || !location) { alert('Please fill in all required fields.'); return; }
                    const tempPassword = generateTempPassword(10);
                    const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                    const existing = companies.find(c => (c.companyEmail || c.email || '').toLowerCase() === email.toLowerCase());
                    if (existing) { alert('An account with this email already exists.'); return; }
                    const id = 'FO-' + Math.random().toString(36).slice(2,8).toUpperCase();
                    const company = {
                        id: id,
                        firstName: given,
                        middleName: middle,
                        lastName: last,
                        companyName: org,
                        phone: phone,
                        companyEmail: email,
                        location: location,
                        status: 'approved',
                        createdAt: new Date().toISOString(),
                        password: tempPassword
                    };
                    companies.push(company);
                    localStorage.setItem('companies', JSON.stringify(companies));
                    loadData();
                    renderFacilityOwners(state.facilityOwnersFiltered);
                    foForm.reset();
                    // Prepare email with credentials
                    const subject = encodeURIComponent('Your FINSI Facility Owner Account Credentials');
                    const bodyLines = [
                        `Hello ${given} ${last},`,
                        '',
                        'Your Facility Owner account has been created and approved.',
                        `Email: ${email}`,
                        `Temporary Password: ${tempPassword}`,
                        '',
                        'Login here: https://example.com/login or open the app Login page.',
                        '',
                        'For security, please sign in and change your password immediately.',
                        '',
                        'Thank you,',
                        'Project Manager'
                    ];
                    const body = encodeURIComponent(bodyLines.join('\n'));
                    const mailto = `mailto:${email}?subject=${subject}&body=${body}`;
                    try { window.location.href = mailto; } catch(e) {}
                    alert('Account created. A prefilled email with credentials is being prepared in your mail client.');
                });
            }
            renderEngineers(state.engineersFiltered);
        });
    </script>

    <script>
        function seedDummyEngineers() {
            return [
                { id: 'ENG-7XA12B', givenName: 'Anna', middleName: 'Lopez', lastName: 'Reyes', phoneNumber: '0917 111 2233', email: 'anna.reyes@finsi.com', location: 'Quezon City', password: 'Ann@2025!' },
                { id: 'ENG-3KD84M', givenName: 'Bryan', middleName: 'Cruz', lastName: 'Santos', phoneNumber: '0917 222 3344', email: 'bryan.santos@finsi.com', location: 'Makati City', password: 'Bry@n#2025' },
                { id: 'ENG-9QP02Z', givenName: 'Carla', middleName: 'M.', lastName: 'Navarro', phoneNumber: '0917 333 4455', email: 'carla.navarro@finsi.com', location: 'Taguig City', password: 'Car!a2025' },
                { id: 'ENG-5RT67P', givenName: 'Daniel', middleName: 'Garcia', lastName: 'Mendoza', phoneNumber: '0917 444 5566', email: 'daniel.mendoza@finsi.com', location: 'Pasig City', password: 'Dan!3l#2025' },
                { id: 'ENG-8WN45K', givenName: 'Elena', middleName: 'Ramos', lastName: 'Torres', phoneNumber: '0917 555 6677', email: 'elena.torres@finsi.com', location: 'Manila City', password: 'El3na$2025' }
            ];
        }

        function seedDummyFacilityOwners() {
            return [
                // Approved accounts
                { id: 'FO-A1B2C3', firstName: 'Roberto', middleName: 'Santos', lastName: 'Cruz', companyName: 'BGC Corporate Tower', phone: '0918 111 2233', companyEmail: 'roberto.cruz@bgccorp.com', location: 'Bonifacio Global City, Taguig City', status: 'approved', createdAt: '2024-12-01T10:00:00Z', password: 'Rob3rto#2025' },
                { id: 'FO-D4E5F6', firstName: 'Maria', middleName: 'Angeles', lastName: 'Fernandez', companyName: 'Ortigas Business Plaza', phone: '0918 222 3344', companyEmail: 'maria.fernandez@ortigasplaza.com', location: 'Ortigas Center, Pasig City', status: 'approved', createdAt: '2024-12-02T11:30:00Z', password: 'Mar!a@2025' },
                { id: 'FO-G7H8I9', firstName: 'Jose', middleName: 'Miguel', lastName: 'Villanueva', companyName: 'Makati Central Square', phone: '0918 333 4455', companyEmail: 'jose.villanueva@makaticentralsq.com', location: 'Ayala Avenue, Makati City', status: 'approved', createdAt: '2024-12-03T09:15:00Z', password: 'Jos3$2025!' },
                
                // Pending accounts (with passwords from registration)
                { id: 'FO-P1Q2R3', firstName: 'Carlos', middleName: 'Eduardo', lastName: 'Mendoza', companyName: 'Alabang Town Center', phone: '0918 666 7788', companyEmail: 'carlos.mendoza@alabangtown.com', location: 'Alabang, Muntinlupa City', status: 'pending', createdAt: '2024-12-10T08:30:00Z', password: 'Carl0s@2024' },
                { id: 'FO-S4T5U6', firstName: 'Sophia', middleName: 'Grace', lastName: 'Lim', companyName: 'SM Megamall Office Tower', phone: '0918 777 8899', companyEmail: 'sophia.lim@smmegamall.com', location: 'EDSA, Mandaluyong City', status: 'pending', createdAt: '2024-12-11T09:45:00Z', password: 'Soph!a#2024' },
                { id: 'FO-V7W8X9', firstName: 'Michael', middleName: 'Angelo', lastName: 'Torres', companyName: 'Rockwell Business Center', phone: '0918 888 9900', companyEmail: 'michael.torres@rockwellcenter.com', location: 'Rockwell, Makati City', status: 'pending', createdAt: '2024-12-12T10:15:00Z', password: 'M!ch@el2024' },
                
                // Rejected accounts (with passwords from registration)
                { id: 'FO-Y1Z2A3', firstName: 'Jennifer', middleName: 'Rose', lastName: 'Garcia', companyName: 'Incomplete Details Corp', phone: '0918 999 0011', companyEmail: 'jennifer.garcia@incomplete.com', location: 'Unknown Location', status: 'rejected', createdAt: '2024-12-08T14:20:00Z', password: 'J3nn!fer@2024', rejectionReason: 'Incomplete company verification documents' },
                { id: 'FO-B4C5D6', firstName: 'Ricardo', middleName: 'Jose', lastName: 'Santos', companyName: 'Invalid Company LLC', phone: '0918 000 1122', companyEmail: 'ricardo.santos@invalid.com', location: 'Manila City', status: 'rejected', createdAt: '2024-12-09T15:30:00Z', password: 'R!card0#2024', rejectionReason: 'Company not found in business registry' }
            ];
        }

        function getHardcodedAppointments() {
            // Always return exactly 5 per category for UI-only demo
            return {
                request: [
                    { id: 'REQ-1001', ticketNumber: 'TKT-1001', date: '2025-10-11 10:00', site: 'Mandaluyong ‚Äì Globe Plaza 2', type: 'Fiber Inspection', description: 'LOS alarms observed; request inspection.', status: 'pending', priority: 'Low', engineer: '' },
                    { id: 'REQ-1002', ticketNumber: 'TKT-1002', date: '2025-10-11 14:30', site: 'Makati ‚Äì Ayala North', type: 'Installation', description: 'New ONT installation for Level 12.', status: 'pending', priority: 'Medium', engineer: '' },
                    { id: 'REQ-1003', ticketNumber: 'TKT-1003', date: '2025-10-12 09:00', site: 'Quezon City ‚Äì North Ave', type: 'Troubleshooting', description: 'Intermittent connectivity reported by tenant.', status: 'pending', priority: 'High', engineer: '' },
                    { id: 'REQ-1004', ticketNumber: 'TKT-1004', date: '2025-10-13 15:15', site: 'Taguig ‚Äì BGC Tower 3', type: 'Upgrade', description: 'Upgrade to 1Gbps link as approved.', status: 'pending', priority: 'Medium', engineer: '' },
                    { id: 'REQ-1005', ticketNumber: 'TKT-1005', date: '2025-10-14 11:45', site: 'Pasig ‚Äì Ortigas Center', type: 'Site Survey', description: 'Pre-installation site survey.', status: 'pending', priority: 'Low', engineer: '' }
                ],
                onhold: [
                    { id: 'ONH-2001', ticketNumber: 'TKT-1002', date: '2025-10-11 14:30', site: 'Makati ‚Äì Ayala North', type: 'Installation', description: 'New ONT installation for Level 12.', status: 'on hold', priority: 'Medium', engineer: 'Anna Reyes', taskStatus: 'approved', assetStatus: 'approved', assetReason: 'ONT equipment and necessary tools available. Ready for installation. Equipment pick-up scheduled for October 15, 2025 at 9:00 AM from the main warehouse.', pmRemarks: 'Materials approved and ready. Please proceed with installation.', engineerRemarks: 'Site assessment completed. Ready to proceed with ONT installation for Level 12.', userEmail: 'facility@ayalanorth.com' },
                    { id: 'ONH-2002', ticketNumber: 'TKT-1002', date: '2025-10-11 14:30', site: 'Makati ‚Äì Ayala North', type: 'Installation', description: 'New ONT installation for Level 12.', status: 'on hold', priority: 'Medium', engineer: 'Anna Reyes', taskStatus: 'on_hold', assetStatus: 'on hold', assetReason: 'Waiting for additional equipment confirmation', pmRemarks: 'Task temporarily on hold pending equipment verification.', engineerRemarks: 'Site assessment completed. Ready to proceed with ONT installation for Level 12.', userEmail: 'facility@ayalanorth.com' },
                    { id: 'ONH-2003', ticketNumber: 'TKT-1002', date: '2025-10-11 14:30', site: 'Makati ‚Äì Ayala North', type: 'Installation', description: 'New ONT installation for Level 12.', status: 'on hold', priority: 'Medium', engineer: 'Anna Reyes', taskStatus: 'inspected', assetStatus: 'approved', assetReason: 'ONT equipment and necessary tools available. Ready for installation.', pmRemarks: 'Inspection completed successfully. All systems verified.', engineerRemarks: 'Site assessment completed. Ready to proceed with ONT installation for Level 12.', userEmail: 'facility@ayalanorth.com' },
                    { id: 'ONH-2004', ticketNumber: 'TKT-1002', date: '2025-10-11 14:30', site: 'Makati ‚Äì Ayala North', type: 'Installation', description: 'New ONT installation for Level 12.', status: 'on hold', priority: 'Medium', engineer: 'Anna Reyes', taskStatus: 'completed', assetStatus: 'approved', assetReason: 'ONT equipment and necessary tools available. Ready for installation.', pmRemarks: 'Installation completed.', engineerRemarks: 'Site assessment completed. Ready to proceed with ONT installation for Level 12.', userEmail: 'facility@ayalanorth.com' },
                    { id: 'ONH-2005', ticketNumber: 'TKT-1002', date: '2025-10-11 14:30', site: 'Makati ‚Äì Ayala North', type: 'Installation', description: 'New ONT installation for Level 12.', status: 'on hold', priority: 'Medium', engineer: 'Anna Reyes', taskStatus: 'in_progress', assetStatus: 'approved', assetReason: 'ONT equipment and necessary tools available. Ready for installation.', pmRemarks: 'Installation in progress. Please provide regular updates.', engineerRemarks: 'Site assessment completed. Ready to proceed with ONT installation for Level 12.', userEmail: 'facility@ayalanorth.com' },
                    { id: 'ONH-2006', ticketNumber: 'TKT-2006', date: '2025-10-15 09:00', site: 'Quezon City ‚Äì Commonwealth Ave', type: 'Repair', description: 'Fiber cable damage reported. Needs immediate attention.', status: 'on hold', priority: 'High', engineer: 'Carlos Reyes', taskStatus: 'pending', assetStatus: 'pending', assetReason: '', pmRemarks: 'Engineer assigned. Awaiting engineer acknowledgment to proceed.', engineerRemarks: '', userEmail: 'facility@qccommonwealth.com' },
                    { id: 'ONH-2007', ticketNumber: 'TKT-2007', date: '2025-10-16 10:30', site: 'Pasig ‚Äì Ortigas Center', type: 'Repair', description: 'Damaged fiber optic cable needs replacement.', status: 'on hold', priority: 'High', engineer: 'Bryan Santos', taskStatus: 'in_progress', assetStatus: 'approved', assetReason: 'Fiber optic cable and splicing equipment ready. Tools checked and available.', pmRemarks: 'Repair work ongoing. Provide hourly updates on progress.', engineerRemarks: 'Damage assessed. Cable section identified. Beginning repair work now.', userEmail: 'facility@ortigascenter.com' },
                    { id: 'ONH-2008', ticketNumber: 'TKT-2008', date: '2025-10-16 13:00', site: 'Taguig ‚Äì BGC Tower 5', type: 'Repair', description: 'Connector replacement required for network stability.', status: 'on hold', priority: 'Medium', engineer: 'Daniel Mendoza', taskStatus: 'approved', assetStatus: 'approved', assetReason: 'LC/SC connectors and cleaning tools available. Ready for connector replacement. Equipment pick-up scheduled for October 17, 2025 at 8:00 AM from BGC warehouse.', pmRemarks: 'Materials approved and ready. Please proceed with connector replacement.', engineerRemarks: 'Connector issues confirmed. Ready to replace faulty connectors.', userEmail: 'facility@bgctower5.com' },
                    { id: 'ONH-2009', ticketNumber: 'TKT-2009', date: '2025-10-17 08:45', site: 'Manila ‚Äì Binondo', type: 'Repair', description: 'Patch panel repair needed urgently.', status: 'on hold', priority: 'High', engineer: 'Elena Torres', taskStatus: 'on_hold', assetStatus: 'on hold', assetReason: 'Waiting for patch panel replacement parts to arrive from supplier', pmRemarks: 'Task temporarily on hold pending parts delivery. Expected arrival October 18.', engineerRemarks: 'Patch panel damage assessed. Awaiting replacement parts to proceed.', userEmail: 'facility@binondo.com' },
                    { id: 'ONH-2010', ticketNumber: 'TKT-2010', date: '2025-10-17 11:00', site: 'Quezon City ‚Äì Cubao', type: 'Repair', description: 'Fiber splice repair and testing required.', status: 'on hold', priority: 'Medium', engineer: 'Carla Navarro', taskStatus: 'inspected', assetStatus: 'approved', assetReason: 'Splicing equipment and OTDR testing device available. Ready for repair.', pmRemarks: 'Inspection completed successfully. All systems verified.', engineerRemarks: 'Splice point located and tested. Repair completed and verified with OTDR.', userEmail: 'facility@cubao.com' },
                    { id: 'ONH-2011', ticketNumber: 'TKT-2011', date: '2025-10-17 14:15', site: 'Mandaluyong ‚Äì Shaw Blvd', type: 'Repair', description: 'Emergency cable restoration after construction damage.', status: 'on hold', priority: 'High', engineer: 'Anna Reyes', taskStatus: 'completed', assetStatus: 'approved', assetReason: 'Emergency repair kit and backup cable available. All tools ready.', pmRemarks: 'Repair completed.', engineerRemarks: 'Emergency cable restoration completed. All connections tested and verified operational.', userEmail: 'facility@shawblvd.com' }
                ],
                approved: [
                    { id: 'APP-3001', ticketNumber: 'TKT-3001', date: '2025-10-08 09:30', site: 'Makati ‚Äì Ayala Ave', type: 'Inspection', description: 'Routine site check.', status: 'completed', priority: 'Low', engineer: 'Anna Reyes', pmRemarks: 'Complete inspection and submit report by EOD.' },
                    { id: 'APP-3002', ticketNumber: 'TKT-3002', date: '2025-10-08 13:30', site: 'Ortigas ‚Äì Sapphire Rd', type: 'Repair', description: 'Replace SFP module.', status: 'completed', priority: 'Medium', engineer: 'Bryan Santos', pmRemarks: 'Ensure proper testing after replacement.' },
                    { id: 'APP-3003', ticketNumber: 'TKT-3003', date: '2025-10-09 10:15', site: 'QC ‚Äì Katipunan', type: 'Troubleshooting', description: 'No connectivity from 2PM.', status: 'completed', priority: 'High', engineer: 'Carla Navarro', pmRemarks: 'Urgent - customer has critical operations running.' },
                    { id: 'APP-3004', ticketNumber: 'TKT-3004', date: '2025-10-09 15:00', site: 'Taguig ‚Äì BGC', type: 'Upgrade', description: 'Upgrade P2P link.', status: 'completed', priority: 'Medium', engineer: 'Daniel Mendoza', pmRemarks: 'Schedule during off-peak hours to minimize disruption.' },
                    { id: 'APP-3005', ticketNumber: 'TKT-3005', date: '2025-10-10 11:20', site: 'Mandaluyong ‚Äì Pioneer', type: 'Installation', description: 'New drop fiber.', status: 'completed', priority: 'Low', engineer: 'Elena Torres', pmRemarks: 'New installation - verify all connections thoroughly.' }
                ],
                rejected: [
                    { id: 'REJ-4001', ticketNumber: 'TKT-4001', date: '2025-10-07 12:00', site: 'Manila ‚Äì Intramuros', type: 'Inspection', description: 'Invalid request details.', status: 'rejected', priority: 'Low', engineer: '' },
                    { id: 'REJ-4002', ticketNumber: 'TKT-4002', date: '2025-10-07 16:00', site: 'QC ‚Äì Commonwealth', type: 'Troubleshooting', description: 'Duplicate ticket.', status: 'rejected', priority: 'Low', engineer: '' },
                    { id: 'REJ-4003', ticketNumber: 'TKT-4003', date: '2025-10-08 08:45', site: 'Pasig ‚Äì Tiendesitas', type: 'Installation', description: 'Insufficient verification.', status: 'rejected', priority: 'Medium', engineer: '' },
                    { id: 'REJ-4004', ticketNumber: 'TKT-4004', date: '2025-10-09 14:35', site: 'Taguig ‚Äì Bayani Rd', type: 'Repair', description: 'Scope mismatch.', status: 'rejected', priority: 'Low', engineer: '' },
                    { id: 'REJ-4005', ticketNumber: 'TKT-4005', date: '2025-10-10 17:10', site: 'Caloocan ‚Äì Monumento', type: 'Upgrade', description: 'Schedule conflict.', status: 'rejected', priority: 'Medium', engineer: '' }
                ]
            };
        }
    </script>
</head>
<body>
	<div class="layout">
		<aside class="sidebar">
			<div class="userbox">
				<img class="avatar" src="profile.jpg" alt="Profile">
				<div class="username">Project Manager</div>
			</div>
			<nav>
				<ul class="navlist">
					<li><a class="nav-link active" data-view="dashboard" href="#"><span class="nav-icon">üìä</span>Dashboard</a></li>
					<li>
						<a class="nav-link has-children" data-toggle="accounts" href="#"><span class="nav-icon">üë•</span>Accounts<span class="nav-caret">‚ñæ</span></a>
						<ul class="nav-sublist" id="accounts-subnav" style="display:none;">
							<li><a class="nav-link" data-view="account-management" href="#">Facility Owner Account Management</a></li>
							<li><a class="nav-link" data-view="engineers" href="#">Engineers</a></li>
							<li><a class="nav-link" data-view="facility-owners" href="#">Facility Owner Accounts</a></li>
						</ul>
					</li>
					<li><a class="nav-link" data-view="notifications" href="#"><span class="nav-icon">üîî</span>Notifications</a></li>
					<li>
						<a class="nav-link has-children" data-toggle="appointments" href="#"><span class="nav-icon">üìÖ</span>Appointments<span class="nav-caret">‚ñæ</span></a>
						<ul class="nav-sublist" id="appointments-subnav" style="display:none;">
							<li><a class="nav-link" data-view="request-appointments" href="#">Request Appointments</a></li>
							<li><a class="nav-link" data-view="onhold-appointments" href="#">In Progress Appointments</a></li>
							<li><a class="nav-link" data-view="approved-appointments" href="#">Completed Appointments</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<div class="sidebar-footer">
				<a class="logout" href="pm_login.html"><span class="nav-icon">‚Üó</span>Logout</a>
			</div>
		</aside>
		<div>
			<div class="topbar">
				<div class="welcome-text">Welcome, Project Manager!</div>
				<div class="finsi-logo">
					<img src="finsi.png" alt="FINSI Logo" class="logo-image">
				</div>
			</div>
			<div class="content">
				<!-- Dashboard View -->
				<div id="dashboard-view" class="view-section active">
					<div class="dashboard-grid">
						<div class="dashboard-overview">
							<h2 class="overview-title">Dashboard Overview</h2>
						<div class="stats-grid">
							<div class="stat-card">
								<div class="stat-icon">üé´</div>
								<div class="stat-number" id="totalTickets">0</div>
								<div class="stat-label">Total Tickets</div>
							</div>
							<div class="stat-card">
								<div class="stat-icon">‚è∞</div>
								<div class="stat-number" id="pendingApprovals">0</div>
								<div class="stat-label">Pending Approvals</div>
							</div>
							<div class="stat-card">
								<div class="stat-icon">üö´</div>
								<div class="stat-number" id="rejectedTasks">0</div>
								<div class="stat-label">Rejected Tasks</div>
							</div>
							<div class="stat-card" onclick="navigateToAccounts('pending')" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)';">
								<div class="stat-icon">üë•</div>
								<div class="stat-number" id="pendingFOAccounts">0</div>
								<div class="stat-label">Pending FO Accounts</div>
							</div>
						</div>
						</div>
						
						<!-- Calendar Widget -->
						<div class="calendar-widget">
							<div class="calendar-header">
								<h3 class="calendar-title" id="calendarTitle">December 2024</h3>
								<div class="calendar-nav">
									<button class="calendar-nav-btn" id="prevMonth">‚Äπ</button>
									<button class="calendar-nav-btn" id="nextMonth">‚Ä∫</button>
								</div>
							</div>
							<div class="calendar-grid" id="calendarGrid">
								<!-- Calendar will be generated by JavaScript -->
							</div>
						</div>
					</div>
				</div>

				<!-- Account Management View -->
				<div id="account-management-view" class="view-section">
					<div class="card">
						<div class="card-header">
							<h2 class="card-title">Facility Owner Account Management</h2>
							<div class="header-actions">
								<select id="accountStatusFilter" style="padding: 8px 12px; border: 1px solid #dce6f5; border-radius: 8px; font-size: 14px; cursor: pointer;">
									<option value="all">All Accounts</option>
									<option value="pending">Pending</option>
									<option value="approved">Approved</option>
									<option value="rejected">Rejected</option>
								</select>
								<input id="searchAccounts" type="text" placeholder="Search by name, company, or email" style="width: 300px;">
							</div>
						</div>
						<div style="overflow-x: auto;">
							<table class="table" id="accountsTable" style="width: 100%; table-layout: auto;">
								<thead>
									<tr>
										<th style="width: 5%; min-width: 50px; text-align: center;">ID</th>
										<th style="width: 18%; min-width: 130px;">Full Name</th>
										<th style="width: 15%; min-width: 120px;">Company Name</th>
										<th style="width: 22%; min-width: 160px;">Email</th>
										<th style="width: 12%; min-width: 100px;">Contact Number</th>
										<th style="width: 13%; min-width: 100px;">Password</th>
										<th style="width: 10%; min-width: 85px; text-align: center;">Status</th>
										<th style="width: 5%; min-width: 70px; text-align: center;">Action</th>
									</tr>
								</thead>
								<tbody id="accountsBody"></tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Engineers View -->
				<div id="engineers-view" class="view-section">
					<div class="card">
						<div class="card-header">
							<h2 class="card-title">Engineers</h2>
							<div class="header-actions">
								<input id="searchEngineers" type="text" placeholder="Search engineers by name, email, or phone">
								<button id="addEngineerBtn" class="action-btn" onclick="openEngineerModal()" style="cursor: pointer; z-index: 999;">Add Engineer</button>
							</div>
						</div>
						<table class="table" id="engineersTable">
							<thead>
								<tr>
									<th>ID</th>
									<th>Given Name</th>
									<th>Middle Name</th>
									<th>Last Name</th>
									<th>Phone Number</th>
									<th>Email Address</th>
									<th>Location/Coverage</th>
									<th>Password</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody id="engineersBody"></tbody>
						</table>
					</div>
				</div>

				<!-- Facility Owners View -->
				<div id="facility-owners-view" class="view-section">
					<div class="card">
						<div class="card-header">
							<h2 class="card-title">Facility Owner Accounts</h2>
							<div class="header-actions">
								<input id="searchFacilityOwners" type="text" placeholder="Search facility owners by name, company, or location">
							</div>
						</div>
						<table class="table" id="facilityOwnersTable">
							<thead>
								<tr>
									<th>ID</th>
									<th>Given Name</th>
									<th>Middle Name</th>
									<th>Last Name</th>
									<th>Organization</th>
									<th>Phone Number</th>
									<th>Email Address</th>
									<th>Location</th>
									<th>Password</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody id="facilityOwnersBody"></tbody>
						</table>
					</div>
				</div>

				<!-- Notifications View -->
				<div id="notifications-view" class="view-section">
					<div class="card">
						<div class="card-header">
							<h2 class="card-title">Notifications</h2>
						</div>
						<div style="padding:20px;">
							<div id="notificationsContainer">
								<!-- New Appointment Request -->
								<div class="notification-card">
									<div class="notification-header">
										<div class="notification-title">üîî New Appointment Request</div>
										<div class="notification-time">5 minutes ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-1001</strong> - Fiber Inspection at Mandaluyong ‚Äì Globe Plaza 2<br>
										Priority: <span class="priority-low">Low</span> | Scheduled: 2025-10-11 10:00
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('request-appointments-view')">View Request</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Asset Management Approved -->
								<div class="notification-card">
									<div class="notification-header">
										<div class="notification-title">‚úÖ Asset Management Approved</div>
										<div class="notification-time">1 hour ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-1002</strong> - New ONT installation for Level 12<br>
										ONT equipment and necessary tools confirmed available. Ready for installation.
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('onhold-appointments-view')">Review Appointment</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Asset Management Rejected -->
								<div class="notification-card">
									<div class="notification-header">
										<div class="notification-title">‚ùå Asset Management Rejected</div>
										<div class="notification-time">2 hours ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-2004</strong> - Deploy new ONT for Suite 403<br>
										Reason: ONT units out of stock, expected delivery in 3 days.<br>
										<em>Action required: Notify Facility Owner</em>
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('onhold-appointments-view')">Notify FO</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Engineer Assignment Needed -->
								<div class="notification-card">
									<div class="notification-header">
										<div class="notification-title">‚ö†Ô∏è Engineer Assignment Needed</div>
										<div class="notification-time">3 hours ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-1002</strong> - New ONT installation for Level 12<br>
										Priority: <span class="priority-medium">Medium</span> | Awaiting engineer assignment
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('request-appointments-view')">Assign Engineer</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Pending Asset Review -->
								<div class="notification-card">
									<div class="notification-header">
										<div class="notification-title">‚è≥ Pending Asset Review</div>
										<div class="notification-time">4 hours ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-1001</strong> - Site Inspection at Quezon City - North Fairview<br>
										Engineer assigned. Site malfunction reported - inspection in progress.
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('onhold-appointments-view')">View Status</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Status Update: In Progress -->
								<div class="notification-card" style="border-left: 4px solid #3b82f6;">
									<div class="notification-header">
										<div class="notification-title">üîÑ Status Update: In Progress</div>
										<div class="notification-time">5 hours ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-2003</strong> - Switch to new splitter module at Cebu ‚Äì IT Park<br>
										Engineer <strong>Carla Navarro</strong> has started working on this task.<br>
										<span style="display: inline-block; margin-top: 6px; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 12px; font-weight: 600;">üîÑ In Progress</span>
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('onhold-appointments-view')">View Details</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Status Update: Approved -->
								<div class="notification-card" style="border-left: 4px solid #10b981;">
									<div class="notification-header">
										<div class="notification-title">‚úÖ Status Update: Materials Approved</div>
										<div class="notification-time">6 hours ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-1002</strong> - New ONT installation for Level 12 at Makati ‚Äì Ayala North<br>
										Asset Management has approved the ONT equipment and tools. Engineer can proceed with installation.<br>
										<span style="display: inline-block; margin-top: 6px; padding: 4px 8px; background: #dcfce7; color: #166534; border-radius: 4px; font-size: 12px; font-weight: 600;">‚úÖ Approved</span>
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('onhold-appointments-view')">View Details</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Status Update: Inspection Completed -->
								<div class="notification-card" style="border-left: 4px solid #059669;">
									<div class="notification-header">
										<div class="notification-title">‚úÖ Status Update: Inspection Completed</div>
										<div class="notification-time">7 hours ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-2005</strong> - Check cabinet ventilation and power at Baguio ‚Äì Session Rd<br>
										Engineer <strong>Elena Torres</strong> has completed the inspection.<br>
										<em>Remarks: "Inspection completed. All systems operational. Cabinet ventilation and power supply functioning normally."</em><br>
										<span style="display: inline-block; margin-top: 6px; padding: 4px 8px; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 12px; font-weight: 600;">‚úÖ Mark as Inspected</span>
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('onhold-appointments-view')">Review & Mark as Done</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>

								<!-- Engineer Update Notification -->
								<div class="notification-card" style="border-left: 4px solid #f59e0b;">
									<div class="notification-header">
										<div class="notification-title">üí¨ Engineer Update</div>
										<div class="notification-time">8 hours ago</div>
									</div>
									<div class="notification-content">
										<strong>TKT-1001</strong> - Site Inspection at Quezon City - North Fairview<br>
										Engineer <strong>Bryan Santos</strong> added a remark:<br>
										<em>"En route to site. Will conduct thorough inspection upon arrival."</em>
									</div>
									<div class="notification-actions">
										<button class="notification-btn" onclick="switchView('onhold-appointments-view')">View Ticket</button>
										<button class="notification-btn secondary" onclick="this.closest('.notification-card').remove()">Dismiss</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Appointments: Request -->
				<div id="request-appointments-view" class="view-section">
					<div class="card">
						<div class="card-header"><h2 class="card-title">Request Appointments</h2></div>
						<div class="searchbar"><input id="searchRequestAppointments" type="text" placeholder="Search request appointments by ticket, date, site, or description"></div>
                    <table class="table" id="requestAppointmentsTable"><thead><tr><th>ID</th><th>Ticket</th><th>Date/Time</th><th>Site</th><th>Type of Appointment</th><th>Task Description/Issue</th><th>Status</th><th>Priority Level</th><th>Engineer</th><th>Action</th></tr></thead><tbody>
<tr><td>1</td><td>TKT-1001</td><td>2025-10-11 10:00</td><td>Mandaluyong ‚Äì Globe Plaza 2</td><td>Fiber Inspection</td><td>LOS alarms observed; request inspection.</td><td>Pending</td><td>Low</td><td>‚Äî</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REQ-1001')">View</button></div></td></tr>
<tr><td>2</td><td>TKT-1002</td><td>2025-10-11 14:30</td><td>Makati ‚Äì Ayala North</td><td>Installation</td><td>New ONT installation for Level 12.</td><td>Pending</td><td>Medium</td><td>‚Äî</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REQ-1002')">View</button></div></td></tr>
<tr><td>3</td><td>TKT-1003</td><td>2025-10-12 09:00</td><td>Quezon City ‚Äì North Ave</td><td>Troubleshooting</td><td>Intermittent connectivity reported by tenant.</td><td>Pending</td><td>High</td><td>‚Äî</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REQ-1003')">View</button></div></td></tr>
<tr><td>4</td><td>TKT-1004</td><td>2025-10-13 15:15</td><td>Taguig ‚Äì BGC Tower 3</td><td>Upgrade</td><td>Upgrade to 1Gbps link as approved.</td><td>Pending</td><td>Medium</td><td>‚Äî</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REQ-1004')">View</button></div></td></tr>
<tr><td>5</td><td>TKT-1005</td><td>2025-10-14 11:45</td><td>Pasig ‚Äì Ortigas Center</td><td>Site Survey</td><td>Pre-installation site survey.</td><td>Pending</td><td>Low</td><td>‚Äî</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REQ-1005')">View</button></div></td></tr>
</tbody></table>

					</div>
				</div>

				<!-- Appointments: In Progress -->
				<div id="onhold-appointments-view" class="view-section">
					<div class="card">
						<div class="card-header">
							<h2 class="card-title">In Progress Appointments</h2>
							<div class="header-actions">
								<select id="statusFilterOnHold" style="padding: 8px 12px; border: 1px solid #dce6f5; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 10px;">
									<option value="all">All Statuses</option>
									<option value="pending">Pending</option>
									<option value="in_progress">Ongoing</option>
									<option value="approved">Approved</option>
									<option value="on_hold">On Hold</option>
									<option value="inspected">Mark as Inspected</option>
									<option value="completed">Completed</option>
								</select>
							</div>
						</div>
						<div class="searchbar"><input id="searchOnHoldAppointments" type="text" placeholder="Search on hold appointments by ticket, date, site, or description"></div>
                    <table class="table" id="onHoldAppointmentsTable"><thead><tr><th>ID</th><th>Ticket</th><th>Date/Time</th><th>Site</th><th>Type of Appointment</th><th>Task Description/Issue</th><th>Status</th><th>Priority Level</th><th>Engineer</th><th>Action</th></tr></thead><tbody id="onHoldAppointmentsBody">
</tbody></table>
					</div>
				</div>

				<!-- Appointments: Completed (History Log) -->
				<div id="approved-appointments-view" class="view-section">
					<div class="card">
						<div class="card-header"><h2 class="card-title">Completed Appointments</h2></div>
						<div class="searchbar"><input id="searchApprovedAppointments" type="text" placeholder="Search completed appointments by ticket, date, site, or description"></div>
                    <table class="table approved-table" id="approvedAppointmentsTable">
							<thead>
								<tr>
									<th>ID</th>
									<th>Ticket</th>
									<th>Date/Time</th>
									<th>Site</th>
									<th>Type of Appointment</th>
									<th>Task Description/Issue</th>
									<th>Status</th>
									<th>Priority Level</th>
									<th>Engineer</th>
								</tr>
							</thead>
							<tbody id="approvedAppointmentsBody">
<tr data-id="APP-3001" onclick="viewTicketDetails('APP-3001')" style="cursor: pointer;">
  <td>1</td>
  <td>TKT-3001</td>
  <td>2025-10-08 09:30</td>
  <td>Makati ‚Äì Ayala Ave</td>
  <td>Inspection</td>
  <td>Routine site check.</td>
  <td><span class="status-badge status-approved">‚úÖ Approved</span></td>
  <td><span class="priority-badge" style="color: #10b981; font-weight: 700;">Low</span></td>
  <td>Anna Reyes</td>
</tr>
<tr data-id="APP-3002" onclick="viewTicketDetails('APP-3002')" style="cursor: pointer;">
  <td>2</td>
  <td>TKT-3002</td>
  <td>2025-10-08 13:30</td>
  <td>Ortigas ‚Äì Sapphire Rd</td>
  <td>Repair</td>
  <td>Replace SFP module.</td>
  <td><span class="status-badge status-approved">‚úÖ Approved</span></td>
  <td><span class="priority-badge" style="color: #f59e0b; font-weight: 700;">Medium</span></td>
  <td>Bryan Santos</td>
</tr>
<tr data-id="APP-3003" onclick="viewTicketDetails('APP-3003')" style="cursor: pointer;">
  <td>3</td>
  <td>TKT-3003</td>
  <td>2025-10-09 10:15</td>
  <td>QC ‚Äì Katipunan</td>
  <td>Troubleshooting</td>
  <td>No connectivity from 2PM.</td>
  <td><span class="status-badge status-approved">‚úÖ Approved</span></td>
  <td><span class="priority-badge" style="color: #ef4444; font-weight: 700;">High</span></td>
  <td>Carla Navarro</td>
</tr>
<tr data-id="APP-3004" onclick="viewTicketDetails('APP-3004')" style="cursor: pointer;">
  <td>4</td>
  <td>TKT-3004</td>
  <td>2025-10-09 15:00</td>
  <td>Taguig ‚Äì BGC</td>
  <td>Upgrade</td>
  <td>Upgrade P2P link.</td>
  <td><span class="status-badge status-approved">‚úÖ Approved</span></td>
  <td><span class="priority-badge" style="color: #f59e0b; font-weight: 700;">Medium</span></td>
  <td>Daniel Mendoza</td>
</tr>
<tr data-id="APP-3005" onclick="viewTicketDetails('APP-3005')" style="cursor: pointer;">
  <td>5</td>
  <td>TKT-3005</td>
  <td>2025-10-10 11:20</td>
  <td>Mandaluyong ‚Äì Pioneer</td>
  <td>Installation</td>
  <td>New drop fiber.</td>
  <td><span class="status-badge status-approved">‚úÖ Approved</span></td>
  <td><span class="priority-badge" style="color: #10b981; font-weight: 700;">Low</span></td>
  <td>Elena Torres</td>
</tr>
</tbody></table>
					</div>
				</div>

				<!-- Appointments: Rejected -->
				<div id="rejected-appointments-view" class="view-section">
					<div class="card">
						<div class="card-header"><h2 class="card-title">Rejected Appointments</h2></div>
						<div class="searchbar"><input id="searchRejectedAppointments" type="text" placeholder="Search rejected appointments by ticket, date, site, or description"></div>
                    <table class="table" id="rejectedAppointmentsTable"><thead><tr><th>ID</th><th>Ticket</th><th>Date/Time</th><th>Site</th><th>Type of Appointment</th><th>Task Description/Issue</th><th>Status</th><th>Priority Level</th><th>Action</th></tr></thead><tbody>
<tr><td>1</td><td>TKT-4001</td><td>2025-10-07 12:00</td><td>Manila ‚Äì Intramuros</td><td>Inspection</td><td>Invalid request details.</td><td>Rejected</td><td>Low</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REJ-4001')">View</button></div></td></tr>
<tr><td>2</td><td>TKT-4002</td><td>2025-10-07 16:00</td><td>QC ‚Äì Commonwealth</td><td>Troubleshooting</td><td>Duplicate ticket.</td><td>Rejected</td><td>Low</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REJ-4002')">View</button></div></td></tr>
<tr><td>3</td><td>TKT-4003</td><td>2025-10-08 08:45</td><td>Pasig ‚Äì Tiendesitas</td><td>Installation</td><td>Insufficient verification.</td><td>Rejected</td><td>Medium</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REJ-4003')">View</button></div></td></tr>
<tr><td>4</td><td>TKT-4004</td><td>2025-10-09 14:35</td><td>Taguig ‚Äì Bayani Rd</td><td>Repair</td><td>Scope mismatch.</td><td>Rejected</td><td>Low</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REJ-4004')">View</button></div></td></tr>
<tr><td>5</td><td>TKT-4005</td><td>2025-10-10 17:10</td><td>Caloocan ‚Äì Monumento</td><td>Upgrade</td><td>Schedule conflict.</td><td>Rejected</td><td>Medium</td><td><div class="row-actions"><button class="action-btn" onclick="viewTicketDetails('REJ-4005')">View</button></div></td></tr>
</tbody></table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Assignment Form Modal -->
	<div id="assignmentModal" class="modal-overlay" onclick="closeAssignmentForm()">
		<div class="assignment-modal-card" onclick="event.stopPropagation()">
			<div class="assignment-modal-header">
				<div class="assignment-modal-title">
					<span class="assignment-icon">‚úèÔ∏è</span>
					<h3>Assign Task</h3>
				</div>
				<button type="button" class="assignment-close-btn" onclick="closeAssignmentForm()">√ó</button>
			</div>
			<div class="assignment-modal-body">
				<form id="assignmentForm">
					<div class="assignment-form-field">
						<label class="assignment-label">Ticket Number</label>
						<input type="text" class="assignment-input assignment-readonly" id="assignmentTicket" readonly>
					</div>
					
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Urgency</label>
							<input type="text" class="assignment-input assignment-readonly" id="assignmentUrgency" readonly>
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Title</label>
							<input type="text" class="assignment-input" id="assignmentTitle">
						</div>
					</div>
					
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Date</label>
							<input type="date" class="assignment-input" id="assignmentDate">
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Time</label>
							<input type="time" class="assignment-input" id="assignmentTime">
						</div>
					</div>
					
					<div class="assignment-form-field">
						<label class="assignment-label">Engineer</label>
						<div class="assignment-input-with-icon">
							<input type="text" class="assignment-input" id="assignmentEngineer" placeholder="Select Engineer">
							<span class="assignment-input-icon">‚ñº</span>
						</div>
					</div>
					
					<div class="assignment-form-field">
						<label class="assignment-label">Site Name</label>
						<input type="text" class="assignment-input assignment-readonly" id="assignmentSiteName" readonly>
					</div>
					
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Contact Person</label>
							<input type="text" class="assignment-input assignment-readonly" id="assignmentContactPerson" readonly>
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Contact Number</label>
							<input type="text" class="assignment-input assignment-readonly" id="assignmentContactNumber" readonly>
						</div>
					</div>
					
					<div class="assignment-form-field">
						<label class="assignment-label">Details</label>
						<textarea class="assignment-textarea assignment-readonly" id="assignmentDetails" rows="8" readonly></textarea>
					</div>
					
					<div class="assignment-form-actions">
						<button type="button" class="assignment-btn assignment-btn-cancel" onclick="closeAssignmentForm()">Cancel</button>
						<button type="submit" class="assignment-btn assignment-btn-assign">Assign</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Ticket Overview Modal -->
	<div id="ticketOverviewModal" class="modal-overlay" onclick="closeTicketOverviewModal()">
		<div class="ticket-overview-modal-card" onclick="event.stopPropagation()">
			<div class="ticket-overview-modal-header">
				<h3 class="ticket-overview-modal-title">Ticket Overview</h3>
				<button type="button" class="ticket-overview-close-btn" onclick="closeTicketOverviewModal()">√ó</button>
			</div>
			<div class="ticket-overview-modal-body">
				<!-- Ticket Information Section -->
				<div class="ticket-info-section">
					<h4 class="section-title">Ticket Information</h4>
					<div class="ticket-info-grid">
						<div class="info-item">
							<label class="info-label">Ticket Number</label>
							<div class="info-value" id="overviewTicket">‚Äî</div>
						</div>
						<div class="info-item">
							<label class="info-label">Date & Time</label>
							<div class="info-value" id="overviewDate">‚Äî</div>
						</div>
						<div class="info-item">
							<label class="info-label">Priority</label>
							<div class="info-value" id="overviewPriority">‚Äî</div>
						</div>
						<div class="info-item">
							<label class="info-label">Type of Appointment</label>
							<div class="info-value" id="overviewType">‚Äî</div>
						</div>
						<div class="info-item">
							<label class="info-label">Site Location</label>
							<div class="info-value" id="overviewSite">‚Äî</div>
						</div>
						<div class="info-item full-width">
							<label class="info-label">Task Description / Issue</label>
							<div class="info-value" id="overviewDescription">‚Äî</div>
						</div>
						<div class="info-item">
							<label class="info-label">Requestor Email</label>
							<div class="info-value" id="overviewEmail">‚Äî</div>
						</div>
					</div>
				</div>

				<!-- Current Status Indicator -->
				<div class="current-status-section" id="currentStatusSection" style="display: none; margin-bottom: 20px;">
					<h4 class="section-title">Current Status</h4>
					<div id="statusIndicator" style="padding: 12px; border-radius: 8px; display: inline-block; font-weight: 600; font-size: 14px;">
						<!-- Status will be dynamically set -->
					</div>
				</div>

				<!-- Remarks / Updates Section (Multi-Actor) -->
				<div class="remarks-section" id="remarksSection" style="display: none;">
					<h4 class="section-title">Remarks / Updates</h4>
					
					<!-- Remarks History Display -->
					<div class="remarks-history" id="remarksHistory" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
						<!-- Remarks will be dynamically populated based on ticket data -->
					</div>
					
					<!-- Remarks to Facility Owner -->
					<div class="fo-remarks-form" id="foRemarksForm" style="margin-top: 20px;">
						<div class="form-field">
							<label class="form-label" style="font-weight: 600; color: #1f2937; margin-bottom: 8px; display: block;">Remarks to Facility Owner</label>
							<textarea id="foRemarkText" class="form-textarea" rows="3" placeholder="Enter remarks that will be visible to the Facility Owner..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
						</div>
					</div>
					
					<!-- On Hold Remarks Section (Hidden by default) -->
					<div id="onHoldRemarksSection" style="display: none; margin-top: 16px; padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px;">
						<div class="form-field">
							<label class="form-label" style="font-weight: 600; color: #92400e; margin-bottom: 8px; display: block;">On Hold Reason (will be sent to Facility Owner)</label>
							<textarea id="onHoldReasonText" class="form-textarea" rows="3" placeholder="Enter reason for putting this appointment on hold..." style="width: 100%; padding: 10px; border: 1px solid #fbbf24; border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical; background: white;"></textarea>
							<div style="margin-top: 8px; display: flex; gap: 8px; justify-content: flex-end;">
								<button type="button" onclick="cancelOnHold()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
								<button type="button" onclick="confirmOnHold()" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Confirm On Hold</button>
							</div>
						</div>
					</div>
				</div>

				<!-- Engineer Assignment Section -->
				<div class="engineer-assignment-section" id="engineerAssignmentSection">
					<h4 class="section-title">Engineer Assignment</h4>
					<div class="assignment-form">
						<div class="form-field">
							<label class="form-label">Assign Engineer</label>
							<select class="form-select" id="engineerSelect">
								<option value="">Select an engineer...</option>
							</select>
						</div>
						<div class="form-field" id="pmRemarksField" style="display: none;">
							<label class="form-label">PM Remarks to Engineer</label>
							<textarea class="form-textarea" id="pmRemarksText" rows="3" placeholder="Enter remarks for the assigned engineer..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
						</div>
						<div class="current-assignment" id="currentAssignment" style="display: none;">
							<label class="form-label">Currently Assigned</label>
							<div class="assigned-engineer" id="assignedEngineer">‚Äî</div>
						</div>
						<div class="current-assignment" id="currentPMRemarks" style="display: none; margin-top: 12px;">
							<label class="form-label">PM Remarks</label>
							<div class="assigned-engineer" id="pmRemarksDisplay" style="background: #f9fafb; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; color: #374151;">‚Äî</div>
						</div>
					</div>
				</div>
				
				<!-- Rejection Reason Section -->
				<div class="rejection-reason-section" id="rejectionReasonSection" style="display: none;">
					<h4 class="section-title">Rejection Details</h4>
					<div class="form-field">
						<label class="form-label">Reason for Rejection (to be sent to Facility Owner)</label>
						<textarea class="form-textarea" id="rejectionReasonText" rows="3" placeholder="Enter the reason why this appointment cannot proceed..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
					</div>
				</div>
				
				<!-- Completion/Done Section -->
				<div class="completion-section" id="doneSection" style="display: none;">
					<h4 class="section-title">Mark Appointment as Complete</h4>
					<div class="form-field">
						<label class="form-label">Completion Remarks (will be visible to Facility Owner)</label>
						<textarea class="form-textarea" id="completionRemarks" rows="3" placeholder="Enter completion remarks (e.g., 'Appointment completed successfully. All work finished and verified.')" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
					</div>
				</div>

				<!-- Action Buttons Section -->
				<div class="action-buttons-section">
					<div class="action-buttons-grid">
						<button type="button" class="action-btn process-btn" id="processBtn" onclick="processTicket()" style="display: none;">
							<span class="btn-icon">‚ö°</span>
							Process Ticket
						</button>
						<button type="button" class="action-btn done-btn" id="markDoneBtn2" onclick="markAsDone()" style="display: none; background: #10b981; border-color: #10b981;">
							<span class="btn-icon">‚úÖ</span>
							Mark as Done
						</button>
						<button type="button" class="action-btn" id="onHoldBtn" onclick="showOnHoldInput()" style="display: none; background: #f59e0b; border-color: #f59e0b;">
							<span class="btn-icon">‚è∏Ô∏è</span>
							On Hold
						</button>
						<button type="button" class="action-btn notify-approve-btn" id="notifyFOApproveBtn" onclick="notifyFOApprove()" style="display: none;">
							<span class="btn-icon">üìß</span>
							Notify FO - Approved
						</button>
						<button type="button" class="action-btn notify-reject-btn" id="notifyFORejectBtn" onclick="notifyFOReject()" style="display: none;">
							<span class="btn-icon">üìß</span>
							Notify FO - Rejected
						</button>
						<button type="button" class="action-btn done-btn" id="markDoneBtn" onclick="markAsDone()" style="display: none; background: #10b981; border-color: #10b981;">
							<span class="btn-icon">‚úÖ</span>
							Mark as Done
						</button>
						<button type="button" class="action-btn delete-btn" id="deleteBtn" onclick="deleteTicket()" style="display: none;">
							<span class="btn-icon">üóëÔ∏è</span>
							Delete
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Engineer Add/Edit Modal -->
	<div id="engineerModal" class="modal-overlay" style="display:none" onclick="closeEngineerModal()">
		<div class="assignment-modal-card" onclick="event.stopPropagation()">
			<div class="assignment-modal-header">
				<div class="assignment-modal-title">
					<span class="assignment-icon">üõ†Ô∏è</span>
					<h3 id="engineerModalTitle">Add Engineer</h3>
				</div>
				<button type="button" class="assignment-close-btn" onclick="closeEngineerModal()">√ó</button>
			</div>
			<div class="assignment-modal-body">
				<form id="engineerForm">
					<input type="hidden" id="engHiddenId">
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Given Name</label>
							<input type="text" class="assignment-input" id="engGivenName">
						</div>
					</div>
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Middle Name</label>
							<input type="text" class="assignment-input" id="engMiddleName">
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Last Name</label>
							<input type="text" class="assignment-input" id="engLastName">
						</div>
					</div>
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Phone Number</label>
							<input type="text" class="assignment-input" id="engPhone">
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Email Address</label>
							<input type="email" class="assignment-input" id="engEmail">
						</div>
					</div>
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Location/Coverage Area</label>
							<input type="text" class="assignment-input" id="engLocation" placeholder="e.g., Metro Manila, Cebu City">
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Password</label>
							<input type="password" class="assignment-input" id="engPassword">
						</div>
					</div>
					<div class="assignment-form-actions">
						<button type="button" class="assignment-btn assignment-btn-cancel" onclick="closeEngineerModal()">Cancel</button>
						<button type="button" id="engDeleteBtn" class="assignment-btn assignment-btn-delete" style="display:none">Delete</button>
						<button type="submit" class="assignment-btn assignment-btn-assign">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Account Detail Modal -->
	<div id="accountDetailModal" class="modal-overlay" style="display:none" onclick="closeAccountDetailModal()">
		<div class="assignment-modal-card" onclick="event.stopPropagation()" style="max-width: 600px;">
			<div class="assignment-modal-header">
				<div class="assignment-modal-title">
					<span class="assignment-icon">üë§</span>
					<h3>Account Details</h3>
				</div>
			</div>
			<div class="assignment-modal-body">
				<div style="display: flex; flex-direction: column; gap: 16px;">
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Account ID:</span>
						<span id="accountDetailId" style="font-family: monospace; color: #6b7280;">-</span>
					</div>
					
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Full Name:</span>
						<span id="accountDetailName" style="color: #1f2937;">-</span>
					</div>
					
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Company:</span>
						<span id="accountDetailCompany" style="color: #1f2937;">-</span>
					</div>
					
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Email:</span>
						<span id="accountDetailEmail" style="color: #1f2937; font-size: 13px;">-</span>
					</div>
					
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Phone:</span>
						<span id="accountDetailPhone" style="color: #1f2937;">-</span>
					</div>
					
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Location:</span>
						<span id="accountDetailLocation" style="color: #1f2937;">-</span>
					</div>
					
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Status:</span>
						<span id="accountDetailStatus" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">-</span>
					</div>
					
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px;">
						<span style="font-weight: 600; color: #374151;">Registered At:</span>
						<span id="accountDetailCreated" style="color: #6b7280; font-size: 13px;">-</span>
					</div>
					
					<div id="accountDetailPasswordRow" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fef3c7; border-radius: 8px; border: 1px solid #fcd34d;">
						<span style="font-weight: 600; color: #92400e;">Password:</span>
						<span id="accountDetailPassword" style="color: #92400e; font-family: monospace; font-weight: 600;">-</span>
					</div>
					
					<div id="accountDetailRejectionRow" style="display: none; flex-direction: column; gap: 8px; padding: 12px; background: #fee2e2; border-radius: 8px; border: 1px solid #fca5a5;">
						<span style="font-weight: 600; color: #991b1b;">Rejection Reason:</span>
						<span id="accountDetailRejectionReason" style="color: #7f1d1d; font-size: 13px;">-</span>
					</div>
				</div>
				
				<div class="assignment-form-actions" style="margin-top: 24px;">
					<button type="button" class="assignment-btn assignment-btn-cancel" onclick="closeAccountDetailModal()">Close</button>
					<button type="button" id="accountDeleteBtn" class="assignment-btn assignment-btn-delete" onclick="deleteAccountFromModal()" style="display:none;">Delete</button>
					<button type="button" id="accountRejectBtn" class="assignment-btn assignment-btn-delete" onclick="rejectAccountFromModal()" style="display:none;">Reject</button>
					<button type="button" id="accountApproveBtn" class="assignment-btn assignment-btn-assign" onclick="approveAccountFromModal()" style="display:none; background: #10b981; border-color: #10b981;">Approve</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Facility Owner Edit Modal -->
	<div id="facilityOwnerModal" class="modal-overlay" style="display:none" onclick="closeFacilityOwnerModal()">
		<div class="assignment-modal-card" onclick="event.stopPropagation()">
			<div class="assignment-modal-header">
				<div class="assignment-modal-title">
					<span class="assignment-icon">üè¢</span>
					<h3 id="foModalTitle">Edit Facility Owner</h3>
				</div>
				<button type="button" class="assignment-close-btn" onclick="closeFacilityOwnerModal()">√ó</button>
			</div>
			<div class="assignment-modal-body">
				<form id="facilityOwnerForm">
					<input type="hidden" id="foHiddenId">
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Given Name</label>
							<input type="text" class="assignment-input" id="foEditGivenName" required>
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Middle Name</label>
							<input type="text" class="assignment-input" id="foEditMiddleName">
						</div>
					</div>
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Last Name</label>
							<input type="text" class="assignment-input" id="foEditLastName" required>
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Organization</label>
							<input type="text" class="assignment-input" id="foEditOrganization" required>
						</div>
					</div>
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Contact Number</label>
							<input type="tel" class="assignment-input" id="foEditContact" required>
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Email Address</label>
							<input type="email" class="assignment-input" id="foEditEmail" required>
						</div>
					</div>
					<div class="assignment-form-row">
						<div class="assignment-form-field">
							<label class="assignment-label">Location</label>
							<input type="text" class="assignment-input" id="foEditLocation" required>
						</div>
						<div class="assignment-form-field">
							<label class="assignment-label">Password</label>
							<input type="password" class="assignment-input" id="foEditPassword" required>
						</div>
					</div>
					<div class="assignment-form-actions">
						<button type="button" class="assignment-btn assignment-btn-cancel" onclick="closeFacilityOwnerModal()">Cancel</button>
						<button type="button" id="foDeleteBtn" class="assignment-btn assignment-btn-delete" style="display:none">Delete</button>
						<button type="submit" class="assignment-btn assignment-btn-assign">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		window.openEngineerModal = function() {
			document.getElementById('engineerModalTitle').textContent = 'Add Engineer';
			document.getElementById('engHiddenId').value = '';
			document.getElementById('engGivenName').value = '';
			document.getElementById('engMiddleName').value = '';
			document.getElementById('engLastName').value = '';
			document.getElementById('engPhone').value = '';
			document.getElementById('engEmail').value = '';
			document.getElementById('engLocation').value = '';
			document.getElementById('engPassword').value = '';
			// Hide delete button in Add mode
			const delBtnAdd = document.getElementById('engDeleteBtn');
			if (delBtnAdd) { delBtnAdd.style.display = 'none'; delBtnAdd.onclick = null; }
			document.getElementById('engineerModal').style.display = 'flex';
			document.body.style.overflow = 'hidden';
			document.getElementById('engineerForm').onsubmit = window.saveEngineer;
		}

		window.closeEngineerModal = function() {
			document.getElementById('engineerModal').style.display = 'none';
			document.body.style.overflow = 'auto';
		}

		window.editEngineer = function(id) {
			const eng = (state.engineers || []).find(e => e.id === id);
			if (!eng) return;
			document.getElementById('engineerModalTitle').textContent = 'Edit Engineer';
			document.getElementById('engHiddenId').value = eng.id || '';
			document.getElementById('engGivenName').value = eng.givenName || '';
			document.getElementById('engMiddleName').value = eng.middleName || '';
			document.getElementById('engLastName').value = eng.lastName || '';
			document.getElementById('engPhone').value = eng.phoneNumber || '';
			document.getElementById('engEmail').value = eng.email || '';
			document.getElementById('engLocation').value = eng.location || '';
			document.getElementById('engPassword').value = eng.password || '';
			document.getElementById('engineerModal').style.display = 'flex';
			document.body.style.overflow = 'hidden';
			document.getElementById('engineerForm').onsubmit = window.saveEngineer;
			// Show and wire delete button in Edit mode
			const delBtn = document.getElementById('engDeleteBtn');
			if (delBtn) {
				delBtn.style.display = '';
				delBtn.onclick = function(){ window.deleteEngineer(eng.id); };
			}
		}

		window.saveEngineer = function(ev) {
			ev.preventDefault();
			const idHidden = document.getElementById('engHiddenId').value.trim();
			const engineer = {
				id: idHidden || ('ENG-' + Math.random().toString(36).slice(2,8).toUpperCase()),
				givenName: document.getElementById('engGivenName').value.trim(),
				middleName: document.getElementById('engMiddleName').value.trim(),
				lastName: document.getElementById('engLastName').value.trim(),
				phoneNumber: document.getElementById('engPhone').value.trim(),
				email: document.getElementById('engEmail').value.trim(),
				location: document.getElementById('engLocation').value.trim(),
				password: document.getElementById('engPassword').value
			};
			const engineers = JSON.parse(localStorage.getItem('engineers') || '[]');
			const idx = engineers.findIndex(e => e.id === (idHidden || engineer.id));
			if (idx >= 0) {
				engineers[idx] = engineer;
			} else {
				engineers.push(engineer);
			}
			localStorage.setItem('engineers', JSON.stringify(engineers));
			loadData();
			renderEngineers(state.engineersFiltered);
			closeEngineerModal();
		}

		window.deleteEngineer = function(id) {
			if (!confirm('Delete this engineer?')) return;
			const engineers = JSON.parse(localStorage.getItem('engineers') || '[]');
			const filtered = engineers.filter(e => e.id !== id);
			localStorage.setItem('engineers', JSON.stringify(filtered));
			loadData();
			renderEngineers(state.engineersFiltered);
			closeEngineerModal();
		}
	</script>

	<script>
		function generateTempPassword(length) {
			const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*';
			let out = '';
			for (let i = 0; i < (length || 10); i++) {
				out += chars.charAt(Math.floor(Math.random() * chars.length));
			}
			return out;
		}
	</script>
</body>
</html>
